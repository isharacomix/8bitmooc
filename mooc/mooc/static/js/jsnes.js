/*
JSNES, based on Jamie Sanders' vNES
Copyright (C) 2010 Ben Firshman

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/
var JSNES=function(a){this.opts={ui:JSNES.DummyUI,swfPath:'lib/',preferredFrameRate:60,fpsInterval:500,showDisplay:true,emulateSound:false,sampleRate:44100,CPU_FREQ_NTSC:1789772.5,CPU_FREQ_PAL:1773447.4};if(typeof a!='undefined'){var b;for(b in this.opts){if(typeof a[b]!='undefined'){this.opts[b]=a[b]}}}this.frameTime=1000/this.opts.preferredFrameRate;this.ui=new this.opts.ui(this);this.cpu=new JSNES.CPU(this);this.ppu=new JSNES.PPU(this);this.papu=new JSNES.PAPU(this);this.mmap=null;this.keyboard=new JSNES.Keyboard();this.ui.updateStatus("Ready to load a ROM.")};JSNES.VERSION="4e7a7260aaaeb7e1c5f6";JSNES.prototype={isRunning:false,fpsFrameCount:0,limitFrames:true,romData:null,reset:function(){if(this.mmap!==null){this.mmap.reset()}this.cpu.reset();this.ppu.reset();this.papu.reset()},start:function(){var a=this;if(this.rom!==null&&this.rom.valid){if(!this.isRunning){this.isRunning=true;this.frameInterval=setInterval(function(){a.frame()},this.frameTime/2);this.resetFps();this.printFps();this.fpsInterval=setInterval(function(){a.printFps()},this.opts.fpsInterval)}}else{this.ui.updateStatus("There is no ROM loaded, or it is invalid.")}},frame:function(){this.ppu.startFrame();var a=0;var b=this.opts.emulateSound;var c=this.cpu;var d=this.ppu;var g=this.papu;FRAMELOOP:for(;;){if(c.cyclesToHalt===0){a=c.emulate();if(b){g.clockFrameCounter(a)}a*=3}else{if(c.cyclesToHalt>8){a=24;if(b){g.clockFrameCounter(8)}c.cyclesToHalt-=8}else{a=c.cyclesToHalt*3;if(b){g.clockFrameCounter(c.cyclesToHalt)}c.cyclesToHalt=0}}for(;a>0;a--){if(d.curX===d.spr0HitX&&d.f_spVisibility===1&&d.scanline-21===d.spr0HitY){d.setStatusFlag(d.STATUS_SPRITE0HIT,true)}if(d.requestEndFrame){d.nmiCounter--;if(d.nmiCounter===0){d.requestEndFrame=false;d.startVBlank();break FRAMELOOP}}d.curX++;if(d.curX===341){d.curX=0;d.endScanline()}}}if(this.limitFrames){if(this.lastFrameTime){while(+new Date()-this.lastFrameTime<this.frameTime){}}}this.fpsFrameCount++;this.lastFrameTime=+new Date()},printFps:function(){var a=+new Date();var b='Running';if(this.lastFpsTime){b+=': '+(this.fpsFrameCount/((a-this.lastFpsTime)/1000)).toFixed(2)+' FPS'}this.ui.updateStatus(b);this.fpsFrameCount=0;this.lastFpsTime=a},stop:function(){clearInterval(this.frameInterval);clearInterval(this.fpsInterval);this.isRunning=false},reloadRom:function(){if(this.romData!==null){this.loadRom(this.romData)}},loadRom:function(a){if(this.isRunning){this.stop()}this.ui.updateStatus("Loading ROM...");this.rom=new JSNES.ROM(this);this.rom.load(a);if(this.rom.valid){this.reset();this.mmap=this.rom.createMapper();if(!this.mmap){return}this.mmap.loadROM();this.ppu.setMirroring(this.rom.getMirroringType());this.romData=a;this.ui.updateStatus("Successfully loaded. Ready to be started.")}else{this.ui.updateStatus("Invalid ROM!")}return this.rom.valid},resetFps:function(){this.lastFpsTime=null;this.fpsFrameCount=0},setFramerate:function(a){this.opts.preferredFrameRate=a;this.frameTime=1000/a;this.papu.setSampleRate(this.opts.sampleRate,false)},setLimitFrames:function(a){this.limitFrames=a;this.lastFrameTime=null},toJSON:function(){return{'romData':this.romData,'cpu':this.cpu.toJSON(),'mmap':this.mmap.toJSON(),'ppu':this.ppu.toJSON()}},fromJSON:function(a){this.loadRom(a.romData);this.cpu.fromJSON(a.cpu);this.mmap.fromJSON(a.mmap);this.ppu.fromJSON(a.ppu)}};JSNES.Utils={copyArrayElements:function(a,b,c,d,g){for(var h=0;h<g;++h){c[d+h]=a[b+h]}},copyArray:function(a){var b=new Array(a.length);for(var c=0;c<a.length;c++){b[c]=a[c]}return b},fromJSON:function(a,b){for(var c=0;c<a.JSON_PROPERTIES.length;c++){a[a.JSON_PROPERTIES[c]]=b[a.JSON_PROPERTIES[c]]}},toJSON:function(a){var b={};for(var c=0;c<a.JSON_PROPERTIES.length;c++){b[a.JSON_PROPERTIES[c]]=a[a.JSON_PROPERTIES[c]]}return b},isIE:function(){return(/msie/i.test(navigator.userAgent)&&!/opera/i.test(navigator.userAgent))}};JSNES.CPU=function(a){this.nes=a;this.mem=null;this.REG_ACC=null;this.REG_X=null;this.REG_Y=null;this.REG_SP=null;this.REG_PC=null;this.REG_PC_NEW=null;this.REG_STATUS=null;this.F_CARRY=null;this.F_DECIMAL=null;this.F_INTERRUPT=null;this.F_INTERRUPT_NEW=null;this.F_OVERFLOW=null;this.F_SIGN=null;this.F_ZERO=null;this.F_NOTUSED=null;this.F_NOTUSED_NEW=null;this.F_BRK=null;this.F_BRK_NEW=null;this.opdata=null;this.cyclesToHalt=null;this.crash=null;this.irqRequested=null;this.irqType=null;this.reset()};JSNES.CPU.prototype={IRQ_NORMAL:0,IRQ_NMI:1,IRQ_RESET:2,reset:function(){this.mem=new Array(0x10000);for(var a=0;a<0x2000;a++){this.mem[a]=0xFF}for(var b=0;b<4;b++){var a=b*0x800;this.mem[a+0x008]=0xF7;this.mem[a+0x009]=0xEF;this.mem[a+0x00A]=0xDF;this.mem[a+0x00F]=0xBF}for(var a=0x2001;a<this.mem.length;a++){this.mem[a]=0}this.REG_ACC=0;this.REG_X=0;this.REG_Y=0;this.REG_SP=0x01FF;this.REG_PC=0x8000-1;this.REG_PC_NEW=0x8000-1;this.REG_STATUS=0x28;this.setStatus(0x28);this.F_CARRY=0;this.F_DECIMAL=0;this.F_INTERRUPT=1;this.F_INTERRUPT_NEW=1;this.F_OVERFLOW=0;this.F_SIGN=0;this.F_ZERO=1;this.F_NOTUSED=1;this.F_NOTUSED_NEW=1;this.F_BRK=1;this.F_BRK_NEW=1;this.opdata=new JSNES.CPU.OpData().opdata;this.cyclesToHalt=0;this.crash=false;this.irqRequested=false;this.irqType=null},emulate:function(){var a;var b;if(this.irqRequested){a=(this.F_CARRY)|((this.F_ZERO===0?1:0)<<1)|(this.F_INTERRUPT<<2)|(this.F_DECIMAL<<3)|(this.F_BRK<<4)|(this.F_NOTUSED<<5)|(this.F_OVERFLOW<<6)|(this.F_SIGN<<7);this.REG_PC_NEW=this.REG_PC;this.F_INTERRUPT_NEW=this.F_INTERRUPT;switch(this.irqType){case 0:{if(this.F_INTERRUPT!=0){break}this.doIrq(a);break}case 1:{this.doNonMaskableInterrupt(a);break}case 2:{this.doResetInterrupt();break}}this.REG_PC=this.REG_PC_NEW;this.F_INTERRUPT=this.F_INTERRUPT_NEW;this.F_BRK=this.F_BRK_NEW;this.irqRequested=false}var c=this.opdata[this.nes.mmap.load(this.REG_PC+1)];var d=(c>>24);var g=0;var h=(c>>8)&0xFF;var f=this.REG_PC;this.REG_PC+=((c>>16)&0xFF);var e=0;switch(h){case 0:{e=this.load(f+2);break}case 1:{e=this.load(f+2);if(e<0x80){e+=this.REG_PC}else{e+=this.REG_PC-256}break}case 2:{break}case 3:{e=this.load16bit(f+2);break}case 4:{e=this.REG_ACC;break}case 5:{e=this.REG_PC;break}case 6:{e=(this.load(f+2)+this.REG_X)&0xFF;break}case 7:{e=(this.load(f+2)+this.REG_Y)&0xFF;break}case 8:{e=this.load16bit(f+2);if((e&0xFF00)!=((e+this.REG_X)&0xFF00)){g=1}e+=this.REG_X;break}case 9:{e=this.load16bit(f+2);if((e&0xFF00)!=((e+this.REG_Y)&0xFF00)){g=1}e+=this.REG_Y;break}case 10:{e=this.load(f+2);if((e&0xFF00)!=((e+this.REG_X)&0xFF00)){g=1}e+=this.REG_X;e&=0xFF;e=this.load16bit(e);break}case 11:{e=this.load16bit(this.load(f+2));if((e&0xFF00)!=((e+this.REG_Y)&0xFF00)){g=1}e+=this.REG_Y;break}case 12:{e=this.load16bit(f+2);if(e<0x1FFF){e=this.mem[e]+(this.mem[(e&0xFF00)|(((e&0xFF)+1)&0xFF)]<<8)}else{e=this.nes.mmap.load(e)+(this.nes.mmap.load((e&0xFF00)|(((e&0xFF)+1)&0xFF))<<8)}break}}e&=0xFFFF;switch(c&0xFF){case 0:{a=this.REG_ACC+this.load(e)+this.F_CARRY;this.F_OVERFLOW=((!(((this.REG_ACC^this.load(e))&0x80)!=0)&&(((this.REG_ACC^a)&0x80))!=0)?1:0);this.F_CARRY=(a>255?1:0);this.F_SIGN=(a>>7)&1;this.F_ZERO=a&0xFF;this.REG_ACC=(a&255);d+=g;break}case 1:{this.REG_ACC=this.REG_ACC&this.load(e);this.F_SIGN=(this.REG_ACC>>7)&1;this.F_ZERO=this.REG_ACC;if(h!=11)d+=g;break}case 2:{if(h==4){this.F_CARRY=(this.REG_ACC>>7)&1;this.REG_ACC=(this.REG_ACC<<1)&255;this.F_SIGN=(this.REG_ACC>>7)&1;this.F_ZERO=this.REG_ACC}else{a=this.load(e);this.F_CARRY=(a>>7)&1;a=(a<<1)&255;this.F_SIGN=(a>>7)&1;this.F_ZERO=a;this.write(e,a)}break}case 3:{if(this.F_CARRY==0){d+=((f&0xFF00)!=(e&0xFF00)?2:1);this.REG_PC=e}break}case 4:{if(this.F_CARRY==1){d+=((f&0xFF00)!=(e&0xFF00)?2:1);this.REG_PC=e}break}case 5:{if(this.F_ZERO==0){d+=((f&0xFF00)!=(e&0xFF00)?2:1);this.REG_PC=e}break}case 6:{a=this.load(e);this.F_SIGN=(a>>7)&1;this.F_OVERFLOW=(a>>6)&1;a&=this.REG_ACC;this.F_ZERO=a;break}case 7:{if(this.F_SIGN==1){d++;this.REG_PC=e}break}case 8:{if(this.F_ZERO!=0){d+=((f&0xFF00)!=(e&0xFF00)?2:1);this.REG_PC=e}break}case 9:{if(this.F_SIGN==0){d+=((f&0xFF00)!=(e&0xFF00)?2:1);this.REG_PC=e}break}case 10:{this.REG_PC+=2;this.push((this.REG_PC>>8)&255);this.push(this.REG_PC&255);this.F_BRK=1;this.push((this.F_CARRY)|((this.F_ZERO==0?1:0)<<1)|(this.F_INTERRUPT<<2)|(this.F_DECIMAL<<3)|(this.F_BRK<<4)|(this.F_NOTUSED<<5)|(this.F_OVERFLOW<<6)|(this.F_SIGN<<7));this.F_INTERRUPT=1;this.REG_PC=this.load16bit(0xFFFE);this.REG_PC--;break}case 11:{if(this.F_OVERFLOW==0){d+=((f&0xFF00)!=(e&0xFF00)?2:1);this.REG_PC=e}break}case 12:{if(this.F_OVERFLOW==1){d+=((f&0xFF00)!=(e&0xFF00)?2:1);this.REG_PC=e}break}case 13:{this.F_CARRY=0;break}case 14:{this.F_DECIMAL=0;break}case 15:{this.F_INTERRUPT=0;break}case 16:{this.F_OVERFLOW=0;break}case 17:{a=this.REG_ACC-this.load(e);this.F_CARRY=(a>=0?1:0);this.F_SIGN=(a>>7)&1;this.F_ZERO=a&0xFF;d+=g;break}case 18:{a=this.REG_X-this.load(e);this.F_CARRY=(a>=0?1:0);this.F_SIGN=(a>>7)&1;this.F_ZERO=a&0xFF;break}case 19:{a=this.REG_Y-this.load(e);this.F_CARRY=(a>=0?1:0);this.F_SIGN=(a>>7)&1;this.F_ZERO=a&0xFF;break}case 20:{a=(this.load(e)-1)&0xFF;this.F_SIGN=(a>>7)&1;this.F_ZERO=a;this.write(e,a);break}case 21:{this.REG_X=(this.REG_X-1)&0xFF;this.F_SIGN=(this.REG_X>>7)&1;this.F_ZERO=this.REG_X;break}case 22:{this.REG_Y=(this.REG_Y-1)&0xFF;this.F_SIGN=(this.REG_Y>>7)&1;this.F_ZERO=this.REG_Y;break}case 23:{this.REG_ACC=(this.load(e)^this.REG_ACC)&0xFF;this.F_SIGN=(this.REG_ACC>>7)&1;this.F_ZERO=this.REG_ACC;d+=g;break}case 24:{a=(this.load(e)+1)&0xFF;this.F_SIGN=(a>>7)&1;this.F_ZERO=a;this.write(e,a&0xFF);break}case 25:{this.REG_X=(this.REG_X+1)&0xFF;this.F_SIGN=(this.REG_X>>7)&1;this.F_ZERO=this.REG_X;break}case 26:{this.REG_Y++;this.REG_Y&=0xFF;this.F_SIGN=(this.REG_Y>>7)&1;this.F_ZERO=this.REG_Y;break}case 27:{this.REG_PC=e-1;break}case 28:{this.push((this.REG_PC>>8)&255);this.push(this.REG_PC&255);this.REG_PC=e-1;break}case 29:{this.REG_ACC=this.load(e);this.F_SIGN=(this.REG_ACC>>7)&1;this.F_ZERO=this.REG_ACC;d+=g;break}case 30:{this.REG_X=this.load(e);this.F_SIGN=(this.REG_X>>7)&1;this.F_ZERO=this.REG_X;d+=g;break}case 31:{this.REG_Y=this.load(e);this.F_SIGN=(this.REG_Y>>7)&1;this.F_ZERO=this.REG_Y;d+=g;break}case 32:{if(h==4){a=(this.REG_ACC&0xFF);this.F_CARRY=a&1;a>>=1;this.REG_ACC=a}else{a=this.load(e)&0xFF;this.F_CARRY=a&1;a>>=1;this.write(e,a)}this.F_SIGN=0;this.F_ZERO=a;break}case 33:{break}case 34:{a=(this.load(e)|this.REG_ACC)&255;this.F_SIGN=(a>>7)&1;this.F_ZERO=a;this.REG_ACC=a;if(h!=11)d+=g;break}case 35:{this.push(this.REG_ACC);break}case 36:{this.F_BRK=1;this.push((this.F_CARRY)|((this.F_ZERO==0?1:0)<<1)|(this.F_INTERRUPT<<2)|(this.F_DECIMAL<<3)|(this.F_BRK<<4)|(this.F_NOTUSED<<5)|(this.F_OVERFLOW<<6)|(this.F_SIGN<<7));break}case 37:{this.REG_ACC=this.pull();this.F_SIGN=(this.REG_ACC>>7)&1;this.F_ZERO=this.REG_ACC;break}case 38:{a=this.pull();this.F_CARRY=(a)&1;this.F_ZERO=(((a>>1)&1)==1)?0:1;this.F_INTERRUPT=(a>>2)&1;this.F_DECIMAL=(a>>3)&1;this.F_BRK=(a>>4)&1;this.F_NOTUSED=(a>>5)&1;this.F_OVERFLOW=(a>>6)&1;this.F_SIGN=(a>>7)&1;this.F_NOTUSED=1;break}case 39:{if(h==4){a=this.REG_ACC;b=this.F_CARRY;this.F_CARRY=(a>>7)&1;a=((a<<1)&0xFF)+b;this.REG_ACC=a}else{a=this.load(e);b=this.F_CARRY;this.F_CARRY=(a>>7)&1;a=((a<<1)&0xFF)+b;this.write(e,a)}this.F_SIGN=(a>>7)&1;this.F_ZERO=a;break}case 40:{if(h==4){b=this.F_CARRY<<7;this.F_CARRY=this.REG_ACC&1;a=(this.REG_ACC>>1)+b;this.REG_ACC=a}else{a=this.load(e);b=this.F_CARRY<<7;this.F_CARRY=a&1;a=(a>>1)+b;this.write(e,a)}this.F_SIGN=(a>>7)&1;this.F_ZERO=a;break}case 41:{a=this.pull();this.F_CARRY=(a)&1;this.F_ZERO=((a>>1)&1)==0?1:0;this.F_INTERRUPT=(a>>2)&1;this.F_DECIMAL=(a>>3)&1;this.F_BRK=(a>>4)&1;this.F_NOTUSED=(a>>5)&1;this.F_OVERFLOW=(a>>6)&1;this.F_SIGN=(a>>7)&1;this.REG_PC=this.pull();this.REG_PC+=(this.pull()<<8);if(this.REG_PC==0xFFFF){return}this.REG_PC--;this.F_NOTUSED=1;break}case 42:{this.REG_PC=this.pull();this.REG_PC+=(this.pull()<<8);if(this.REG_PC==0xFFFF){return}break}case 43:{a=this.REG_ACC-this.load(e)-(1-this.F_CARRY);this.F_SIGN=(a>>7)&1;this.F_ZERO=a&0xFF;this.F_OVERFLOW=((((this.REG_ACC^a)&0x80)!=0&&((this.REG_ACC^this.load(e))&0x80)!=0)?1:0);this.F_CARRY=(a<0?0:1);this.REG_ACC=(a&0xFF);if(h!=11)d+=g;break}case 44:{this.F_CARRY=1;break}case 45:{this.F_DECIMAL=1;break}case 46:{this.F_INTERRUPT=1;break}case 47:{this.write(e,this.REG_ACC);break}case 48:{this.write(e,this.REG_X);break}case 49:{this.write(e,this.REG_Y);break}case 50:{this.REG_X=this.REG_ACC;this.F_SIGN=(this.REG_ACC>>7)&1;this.F_ZERO=this.REG_ACC;break}case 51:{this.REG_Y=this.REG_ACC;this.F_SIGN=(this.REG_ACC>>7)&1;this.F_ZERO=this.REG_ACC;break}case 52:{this.REG_X=(this.REG_SP-0x0100);this.F_SIGN=(this.REG_SP>>7)&1;this.F_ZERO=this.REG_X;break}case 53:{this.REG_ACC=this.REG_X;this.F_SIGN=(this.REG_X>>7)&1;this.F_ZERO=this.REG_X;break}case 54:{this.REG_SP=(this.REG_X+0x0100);this.stackWrap();break}case 55:{this.REG_ACC=this.REG_Y;this.F_SIGN=(this.REG_Y>>7)&1;this.F_ZERO=this.REG_Y;break}default:{this.nes.stop();this.nes.crashMessage="Game crashed, invalid opcode at address $"+f.toString(16);break}}return d},load:function(a){if(a<0x2000){return this.mem[a&0x7FF]}else{return this.nes.mmap.load(a)}},load16bit:function(a){if(a<0x1FFF){return this.mem[a&0x7FF]|(this.mem[(a+1)&0x7FF]<<8)}else{return this.nes.mmap.load(a)|(this.nes.mmap.load(a+1)<<8)}},write:function(a,b){if(a<0x2000){this.mem[a&0x7FF]=b}else{this.nes.mmap.write(a,b)}},requestIrq:function(a){if(this.irqRequested){if(a==this.IRQ_NORMAL){return}}this.irqRequested=true;this.irqType=a},push:function(a){this.nes.mmap.write(this.REG_SP,a);this.REG_SP--;this.REG_SP=0x0100|(this.REG_SP&0xFF)},stackWrap:function(){this.REG_SP=0x0100|(this.REG_SP&0xFF)},pull:function(){this.REG_SP++;this.REG_SP=0x0100|(this.REG_SP&0xFF);return this.nes.mmap.load(this.REG_SP)},pageCrossed:function(a,b){return((a&0xFF00)!=(b&0xFF00))},haltCycles:function(a){this.cyclesToHalt+=a},doNonMaskableInterrupt:function(a){if((this.nes.mmap.load(0x2000)&128)!=0){this.REG_PC_NEW++;this.push((this.REG_PC_NEW>>8)&0xFF);this.push(this.REG_PC_NEW&0xFF);this.push(a);this.REG_PC_NEW=this.nes.mmap.load(0xFFFA)|(this.nes.mmap.load(0xFFFB)<<8);this.REG_PC_NEW--}},doResetInterrupt:function(){this.REG_PC_NEW=this.nes.mmap.load(0xFFFC)|(this.nes.mmap.load(0xFFFD)<<8);this.REG_PC_NEW--},doIrq:function(a){this.REG_PC_NEW++;this.push((this.REG_PC_NEW>>8)&0xFF);this.push(this.REG_PC_NEW&0xFF);this.push(a);this.F_INTERRUPT_NEW=1;this.F_BRK_NEW=0;this.REG_PC_NEW=this.nes.mmap.load(0xFFFE)|(this.nes.mmap.load(0xFFFF)<<8);this.REG_PC_NEW--},getStatus:function(){return(this.F_CARRY)|(this.F_ZERO<<1)|(this.F_INTERRUPT<<2)|(this.F_DECIMAL<<3)|(this.F_BRK<<4)|(this.F_NOTUSED<<5)|(this.F_OVERFLOW<<6)|(this.F_SIGN<<7)},setStatus:function(a){this.F_CARRY=(a)&1;this.F_ZERO=(a>>1)&1;this.F_INTERRUPT=(a>>2)&1;this.F_DECIMAL=(a>>3)&1;this.F_BRK=(a>>4)&1;this.F_NOTUSED=(a>>5)&1;this.F_OVERFLOW=(a>>6)&1;this.F_SIGN=(a>>7)&1},JSON_PROPERTIES:['mem','cyclesToHalt','irqRequested','irqType','REG_ACC','REG_X','REG_Y','REG_SP','REG_PC','REG_PC_NEW','REG_STATUS','F_CARRY','F_DECIMAL','F_INTERRUPT','F_INTERRUPT_NEW','F_OVERFLOW','F_SIGN','F_ZERO','F_NOTUSED','F_NOTUSED_NEW','F_BRK','F_BRK_NEW'],toJSON:function(){return JSNES.Utils.toJSON(this)},fromJSON:function(a){JSNES.Utils.fromJSON(this,a)}}JSNES.CPU.OpData=function(){this.opdata=new Array(256);for(var a=0;a<256;a++)this.opdata[a]=0xFF;this.setOp(this.INS_ADC,0x69,this.ADDR_IMM,2,2);this.setOp(this.INS_ADC,0x65,this.ADDR_ZP,2,3);this.setOp(this.INS_ADC,0x75,this.ADDR_ZPX,2,4);this.setOp(this.INS_ADC,0x6D,this.ADDR_ABS,3,4);this.setOp(this.INS_ADC,0x7D,this.ADDR_ABSX,3,4);this.setOp(this.INS_ADC,0x79,this.ADDR_ABSY,3,4);this.setOp(this.INS_ADC,0x61,this.ADDR_PREIDXIND,2,6);this.setOp(this.INS_ADC,0x71,this.ADDR_POSTIDXIND,2,5);this.setOp(this.INS_AND,0x29,this.ADDR_IMM,2,2);this.setOp(this.INS_AND,0x25,this.ADDR_ZP,2,3);this.setOp(this.INS_AND,0x35,this.ADDR_ZPX,2,4);this.setOp(this.INS_AND,0x2D,this.ADDR_ABS,3,4);this.setOp(this.INS_AND,0x3D,this.ADDR_ABSX,3,4);this.setOp(this.INS_AND,0x39,this.ADDR_ABSY,3,4);this.setOp(this.INS_AND,0x21,this.ADDR_PREIDXIND,2,6);this.setOp(this.INS_AND,0x31,this.ADDR_POSTIDXIND,2,5);this.setOp(this.INS_ASL,0x0A,this.ADDR_ACC,1,2);this.setOp(this.INS_ASL,0x06,this.ADDR_ZP,2,5);this.setOp(this.INS_ASL,0x16,this.ADDR_ZPX,2,6);this.setOp(this.INS_ASL,0x0E,this.ADDR_ABS,3,6);this.setOp(this.INS_ASL,0x1E,this.ADDR_ABSX,3,7);this.setOp(this.INS_BCC,0x90,this.ADDR_REL,2,2);this.setOp(this.INS_BCS,0xB0,this.ADDR_REL,2,2);this.setOp(this.INS_BEQ,0xF0,this.ADDR_REL,2,2);this.setOp(this.INS_BIT,0x24,this.ADDR_ZP,2,3);this.setOp(this.INS_BIT,0x2C,this.ADDR_ABS,3,4);this.setOp(this.INS_BMI,0x30,this.ADDR_REL,2,2);this.setOp(this.INS_BNE,0xD0,this.ADDR_REL,2,2);this.setOp(this.INS_BPL,0x10,this.ADDR_REL,2,2);this.setOp(this.INS_BRK,0x00,this.ADDR_IMP,1,7);this.setOp(this.INS_BVC,0x50,this.ADDR_REL,2,2);this.setOp(this.INS_BVS,0x70,this.ADDR_REL,2,2);this.setOp(this.INS_CLC,0x18,this.ADDR_IMP,1,2);this.setOp(this.INS_CLD,0xD8,this.ADDR_IMP,1,2);this.setOp(this.INS_CLI,0x58,this.ADDR_IMP,1,2);this.setOp(this.INS_CLV,0xB8,this.ADDR_IMP,1,2);this.setOp(this.INS_CMP,0xC9,this.ADDR_IMM,2,2);this.setOp(this.INS_CMP,0xC5,this.ADDR_ZP,2,3);this.setOp(this.INS_CMP,0xD5,this.ADDR_ZPX,2,4);this.setOp(this.INS_CMP,0xCD,this.ADDR_ABS,3,4);this.setOp(this.INS_CMP,0xDD,this.ADDR_ABSX,3,4);this.setOp(this.INS_CMP,0xD9,this.ADDR_ABSY,3,4);this.setOp(this.INS_CMP,0xC1,this.ADDR_PREIDXIND,2,6);this.setOp(this.INS_CMP,0xD1,this.ADDR_POSTIDXIND,2,5);this.setOp(this.INS_CPX,0xE0,this.ADDR_IMM,2,2);this.setOp(this.INS_CPX,0xE4,this.ADDR_ZP,2,3);this.setOp(this.INS_CPX,0xEC,this.ADDR_ABS,3,4);this.setOp(this.INS_CPY,0xC0,this.ADDR_IMM,2,2);this.setOp(this.INS_CPY,0xC4,this.ADDR_ZP,2,3);this.setOp(this.INS_CPY,0xCC,this.ADDR_ABS,3,4);this.setOp(this.INS_DEC,0xC6,this.ADDR_ZP,2,5);this.setOp(this.INS_DEC,0xD6,this.ADDR_ZPX,2,6);this.setOp(this.INS_DEC,0xCE,this.ADDR_ABS,3,6);this.setOp(this.INS_DEC,0xDE,this.ADDR_ABSX,3,7);this.setOp(this.INS_DEX,0xCA,this.ADDR_IMP,1,2);this.setOp(this.INS_DEY,0x88,this.ADDR_IMP,1,2);this.setOp(this.INS_EOR,0x49,this.ADDR_IMM,2,2);this.setOp(this.INS_EOR,0x45,this.ADDR_ZP,2,3);this.setOp(this.INS_EOR,0x55,this.ADDR_ZPX,2,4);this.setOp(this.INS_EOR,0x4D,this.ADDR_ABS,3,4);this.setOp(this.INS_EOR,0x5D,this.ADDR_ABSX,3,4);this.setOp(this.INS_EOR,0x59,this.ADDR_ABSY,3,4);this.setOp(this.INS_EOR,0x41,this.ADDR_PREIDXIND,2,6);this.setOp(this.INS_EOR,0x51,this.ADDR_POSTIDXIND,2,5);this.setOp(this.INS_INC,0xE6,this.ADDR_ZP,2,5);this.setOp(this.INS_INC,0xF6,this.ADDR_ZPX,2,6);this.setOp(this.INS_INC,0xEE,this.ADDR_ABS,3,6);this.setOp(this.INS_INC,0xFE,this.ADDR_ABSX,3,7);this.setOp(this.INS_INX,0xE8,this.ADDR_IMP,1,2);this.setOp(this.INS_INY,0xC8,this.ADDR_IMP,1,2);this.setOp(this.INS_JMP,0x4C,this.ADDR_ABS,3,3);this.setOp(this.INS_JMP,0x6C,this.ADDR_INDABS,3,5);this.setOp(this.INS_JSR,0x20,this.ADDR_ABS,3,6);this.setOp(this.INS_LDA,0xA9,this.ADDR_IMM,2,2);this.setOp(this.INS_LDA,0xA5,this.ADDR_ZP,2,3);this.setOp(this.INS_LDA,0xB5,this.ADDR_ZPX,2,4);this.setOp(this.INS_LDA,0xAD,this.ADDR_ABS,3,4);this.setOp(this.INS_LDA,0xBD,this.ADDR_ABSX,3,4);this.setOp(this.INS_LDA,0xB9,this.ADDR_ABSY,3,4);this.setOp(this.INS_LDA,0xA1,this.ADDR_PREIDXIND,2,6);this.setOp(this.INS_LDA,0xB1,this.ADDR_POSTIDXIND,2,5);this.setOp(this.INS_LDX,0xA2,this.ADDR_IMM,2,2);this.setOp(this.INS_LDX,0xA6,this.ADDR_ZP,2,3);this.setOp(this.INS_LDX,0xB6,this.ADDR_ZPY,2,4);this.setOp(this.INS_LDX,0xAE,this.ADDR_ABS,3,4);this.setOp(this.INS_LDX,0xBE,this.ADDR_ABSY,3,4);this.setOp(this.INS_LDY,0xA0,this.ADDR_IMM,2,2);this.setOp(this.INS_LDY,0xA4,this.ADDR_ZP,2,3);this.setOp(this.INS_LDY,0xB4,this.ADDR_ZPX,2,4);this.setOp(this.INS_LDY,0xAC,this.ADDR_ABS,3,4);this.setOp(this.INS_LDY,0xBC,this.ADDR_ABSX,3,4);this.setOp(this.INS_LSR,0x4A,this.ADDR_ACC,1,2);this.setOp(this.INS_LSR,0x46,this.ADDR_ZP,2,5);this.setOp(this.INS_LSR,0x56,this.ADDR_ZPX,2,6);this.setOp(this.INS_LSR,0x4E,this.ADDR_ABS,3,6);this.setOp(this.INS_LSR,0x5E,this.ADDR_ABSX,3,7);this.setOp(this.INS_NOP,0xEA,this.ADDR_IMP,1,2);this.setOp(this.INS_ORA,0x09,this.ADDR_IMM,2,2);this.setOp(this.INS_ORA,0x05,this.ADDR_ZP,2,3);this.setOp(this.INS_ORA,0x15,this.ADDR_ZPX,2,4);this.setOp(this.INS_ORA,0x0D,this.ADDR_ABS,3,4);this.setOp(this.INS_ORA,0x1D,this.ADDR_ABSX,3,4);this.setOp(this.INS_ORA,0x19,this.ADDR_ABSY,3,4);this.setOp(this.INS_ORA,0x01,this.ADDR_PREIDXIND,2,6);this.setOp(this.INS_ORA,0x11,this.ADDR_POSTIDXIND,2,5);this.setOp(this.INS_PHA,0x48,this.ADDR_IMP,1,3);this.setOp(this.INS_PHP,0x08,this.ADDR_IMP,1,3);this.setOp(this.INS_PLA,0x68,this.ADDR_IMP,1,4);this.setOp(this.INS_PLP,0x28,this.ADDR_IMP,1,4);this.setOp(this.INS_ROL,0x2A,this.ADDR_ACC,1,2);this.setOp(this.INS_ROL,0x26,this.ADDR_ZP,2,5);this.setOp(this.INS_ROL,0x36,this.ADDR_ZPX,2,6);this.setOp(this.INS_ROL,0x2E,this.ADDR_ABS,3,6);this.setOp(this.INS_ROL,0x3E,this.ADDR_ABSX,3,7);this.setOp(this.INS_ROR,0x6A,this.ADDR_ACC,1,2);this.setOp(this.INS_ROR,0x66,this.ADDR_ZP,2,5);this.setOp(this.INS_ROR,0x76,this.ADDR_ZPX,2,6);this.setOp(this.INS_ROR,0x6E,this.ADDR_ABS,3,6);this.setOp(this.INS_ROR,0x7E,this.ADDR_ABSX,3,7);this.setOp(this.INS_RTI,0x40,this.ADDR_IMP,1,6);this.setOp(this.INS_RTS,0x60,this.ADDR_IMP,1,6);this.setOp(this.INS_SBC,0xE9,this.ADDR_IMM,2,2);this.setOp(this.INS_SBC,0xE5,this.ADDR_ZP,2,3);this.setOp(this.INS_SBC,0xF5,this.ADDR_ZPX,2,4);this.setOp(this.INS_SBC,0xED,this.ADDR_ABS,3,4);this.setOp(this.INS_SBC,0xFD,this.ADDR_ABSX,3,4);this.setOp(this.INS_SBC,0xF9,this.ADDR_ABSY,3,4);this.setOp(this.INS_SBC,0xE1,this.ADDR_PREIDXIND,2,6);this.setOp(this.INS_SBC,0xF1,this.ADDR_POSTIDXIND,2,5);this.setOp(this.INS_SEC,0x38,this.ADDR_IMP,1,2);this.setOp(this.INS_SED,0xF8,this.ADDR_IMP,1,2);this.setOp(this.INS_SEI,0x78,this.ADDR_IMP,1,2);this.setOp(this.INS_STA,0x85,this.ADDR_ZP,2,3);this.setOp(this.INS_STA,0x95,this.ADDR_ZPX,2,4);this.setOp(this.INS_STA,0x8D,this.ADDR_ABS,3,4);this.setOp(this.INS_STA,0x9D,this.ADDR_ABSX,3,5);this.setOp(this.INS_STA,0x99,this.ADDR_ABSY,3,5);this.setOp(this.INS_STA,0x81,this.ADDR_PREIDXIND,2,6);this.setOp(this.INS_STA,0x91,this.ADDR_POSTIDXIND,2,6);this.setOp(this.INS_STX,0x86,this.ADDR_ZP,2,3);this.setOp(this.INS_STX,0x96,this.ADDR_ZPY,2,4);this.setOp(this.INS_STX,0x8E,this.ADDR_ABS,3,4);this.setOp(this.INS_STY,0x84,this.ADDR_ZP,2,3);this.setOp(this.INS_STY,0x94,this.ADDR_ZPX,2,4);this.setOp(this.INS_STY,0x8C,this.ADDR_ABS,3,4);this.setOp(this.INS_TAX,0xAA,this.ADDR_IMP,1,2);this.setOp(this.INS_TAY,0xA8,this.ADDR_IMP,1,2);this.setOp(this.INS_TSX,0xBA,this.ADDR_IMP,1,2);this.setOp(this.INS_TXA,0x8A,this.ADDR_IMP,1,2);this.setOp(this.INS_TXS,0x9A,this.ADDR_IMP,1,2);this.setOp(this.INS_TYA,0x98,this.ADDR_IMP,1,2);this.cycTable=new Array(7,6,2,8,3,3,5,5,3,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,4,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,3,2,2,2,3,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,4,2,2,2,5,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,2,6,2,6,3,3,3,3,2,2,2,2,4,4,4,4,2,6,2,6,4,4,4,4,2,5,2,5,5,5,5,5,2,6,2,6,3,3,3,3,2,2,2,2,4,4,4,4,2,5,2,5,4,4,4,4,2,4,2,4,4,4,4,4,2,6,2,8,3,3,5,5,2,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,2,6,3,8,3,3,5,5,2,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7);this.instname=new Array(56);this.instname[0]="ADC";this.instname[1]="AND";this.instname[2]="ASL";this.instname[3]="BCC";this.instname[4]="BCS";this.instname[5]="BEQ";this.instname[6]="BIT";this.instname[7]="BMI";this.instname[8]="BNE";this.instname[9]="BPL";this.instname[10]="BRK";this.instname[11]="BVC";this.instname[12]="BVS";this.instname[13]="CLC";this.instname[14]="CLD";this.instname[15]="CLI";this.instname[16]="CLV";this.instname[17]="CMP";this.instname[18]="CPX";this.instname[19]="CPY";this.instname[20]="DEC";this.instname[21]="DEX";this.instname[22]="DEY";this.instname[23]="EOR";this.instname[24]="INC";this.instname[25]="INX";this.instname[26]="INY";this.instname[27]="JMP";this.instname[28]="JSR";this.instname[29]="LDA";this.instname[30]="LDX";this.instname[31]="LDY";this.instname[32]="LSR";this.instname[33]="NOP";this.instname[34]="ORA";this.instname[35]="PHA";this.instname[36]="PHP";this.instname[37]="PLA";this.instname[38]="PLP";this.instname[39]="ROL";this.instname[40]="ROR";this.instname[41]="RTI";this.instname[42]="RTS";this.instname[43]="SBC";this.instname[44]="SEC";this.instname[45]="SED";this.instname[46]="SEI";this.instname[47]="STA";this.instname[48]="STX";this.instname[49]="STY";this.instname[50]="TAX";this.instname[51]="TAY";this.instname[52]="TSX";this.instname[53]="TXA";this.instname[54]="TXS";this.instname[55]="TYA";this.addrDesc=new Array("Zero Page           ","Relative            ","Implied             ","Absolute            ","Accumulator         ","Immediate           ","Zero Page,X         ","Zero Page,Y         ","Absolute,X          ","Absolute,Y          ","Preindexed Indirect ","Postindexed Indirect","Indirect Absolute   ")}JSNES.CPU.OpData.prototype={INS_ADC:0,INS_AND:1,INS_ASL:2,INS_BCC:3,INS_BCS:4,INS_BEQ:5,INS_BIT:6,INS_BMI:7,INS_BNE:8,INS_BPL:9,INS_BRK:10,INS_BVC:11,INS_BVS:12,INS_CLC:13,INS_CLD:14,INS_CLI:15,INS_CLV:16,INS_CMP:17,INS_CPX:18,INS_CPY:19,INS_DEC:20,INS_DEX:21,INS_DEY:22,INS_EOR:23,INS_INC:24,INS_INX:25,INS_INY:26,INS_JMP:27,INS_JSR:28,INS_LDA:29,INS_LDX:30,INS_LDY:31,INS_LSR:32,INS_NOP:33,INS_ORA:34,INS_PHA:35,INS_PHP:36,INS_PLA:37,INS_PLP:38,INS_ROL:39,INS_ROR:40,INS_RTI:41,INS_RTS:42,INS_SBC:43,INS_SEC:44,INS_SED:45,INS_SEI:46,INS_STA:47,INS_STX:48,INS_STY:49,INS_TAX:50,INS_TAY:51,INS_TSX:52,INS_TXA:53,INS_TXS:54,INS_TYA:55,INS_DUMMY:56,ADDR_ZP:0,ADDR_REL:1,ADDR_IMP:2,ADDR_ABS:3,ADDR_ACC:4,ADDR_IMM:5,ADDR_ZPX:6,ADDR_ZPY:7,ADDR_ABSX:8,ADDR_ABSY:9,ADDR_PREIDXIND:10,ADDR_POSTIDXIND:11,ADDR_INDABS:12,setOp:function(a,b,c,d,g){this.opdata[b]=((a&0xFF))|((c&0xFF)<<8)|((d&0xFF)<<16)|((g&0xFF)<<24)}};JSNES.Keyboard=function(){var a;this.keys={KEY_A:0,KEY_B:1,KEY_SELECT:2,KEY_START:3,KEY_UP:4,KEY_DOWN:5,KEY_LEFT:6,KEY_RIGHT:7};this.state1=new Array(8);for(a=0;a<this.state1.length;a++){this.state1[a]=0x40}this.state2=new Array(8);for(a=0;a<this.state2.length;a++){this.state2[a]=0x40}};JSNES.Keyboard.prototype={setKey:function(a,b){switch(a){case 88:this.state1[this.keys.KEY_A]=b;break;case 89:this.state1[this.keys.KEY_B]=b;break;case 90:this.state1[this.keys.KEY_B]=b;break;case 17:this.state1[this.keys.KEY_SELECT]=b;break;case 13:this.state1[this.keys.KEY_START]=b;break;case 38:this.state1[this.keys.KEY_UP]=b;break;case 40:this.state1[this.keys.KEY_DOWN]=b;break;case 37:this.state1[this.keys.KEY_LEFT]=b;break;case 39:this.state1[this.keys.KEY_RIGHT]=b;break;case 103:this.state2[this.keys.KEY_A]=b;break;case 105:this.state2[this.keys.KEY_B]=b;break;case 99:this.state2[this.keys.KEY_SELECT]=b;break;case 97:this.state2[this.keys.KEY_START]=b;break;case 104:this.state2[this.keys.KEY_UP]=b;break;case 98:this.state2[this.keys.KEY_DOWN]=b;break;case 100:this.state2[this.keys.KEY_LEFT]=b;break;case 102:this.state2[this.keys.KEY_RIGHT]=b;break;default:return true}return false},keyDown:function(a){if(!this.setKey(a.keyCode,0x41)&&a.preventDefault){a.preventDefault()}},keyUp:function(a){if(!this.setKey(a.keyCode,0x40)&&a.preventDefault){a.preventDefault()}},keyPress:function(a){a.preventDefault()}};JSNES.Mappers={};JSNES.Mappers[0]=function(a){this.nes=a};JSNES.Mappers[0].prototype={reset:function(){this.joy1StrobeState=0;this.joy2StrobeState=0;this.joypadLastWrite=0;this.mousePressed=false;this.mouseX=null;this.mouseY=null},write:function(a,b){if(a<0x2000){this.nes.cpu.mem[a&0x7FF]=b}else if(a>0x4017){this.nes.cpu.mem[a]=b;if(a>=0x6000&&a<0x8000){}}else if(a>0x2007&&a<0x4000){this.regWrite(0x2000+(a&0x7),b)}else{this.regWrite(a,b)}},writelow:function(a,b){if(a<0x2000){this.nes.cpu.mem[a&0x7FF]=b}else if(a>0x4017){this.nes.cpu.mem[a]=b}else if(a>0x2007&&a<0x4000){this.regWrite(0x2000+(a&0x7),b)}else{this.regWrite(a,b)}},load:function(a){a&=0xFFFF;if(a>0x4017){return this.nes.cpu.mem[a]}else if(a>=0x2000){return this.regLoad(a)}else{return this.nes.cpu.mem[a&0x7FF]}},regLoad:function(a){switch(a>>12){case 0:break;case 1:break;case 2:case 3:switch(a&0x7){case 0x0:return this.nes.cpu.mem[0x2000];case 0x1:return this.nes.cpu.mem[0x2001];case 0x2:return this.nes.ppu.readStatusRegister();case 0x3:return 0;case 0x4:return this.nes.ppu.sramLoad();case 0x5:return 0;case 0x6:return 0;case 0x7:return this.nes.ppu.vramLoad()}break;case 4:switch(a-0x4015){case 0:return this.nes.papu.readReg(a);case 1:return this.joy1Read();case 2:if(this.mousePressed){var b=Math.max(0,this.mouseX-4);var c=Math.min(256,this.mouseX+4);var d=Math.max(0,this.mouseY-4);var g=Math.min(240,this.mouseY+4);var h=0;for(var f=d;f<g;f++){for(var e=b;e<c;e++){if(this.nes.ppu.buffer[(f<<8)+e]==0xFFFFFF){h|=0x1<<3;console.debug("Clicked on white!");break}}}h|=(this.mousePressed?(0x1<<4):0);return(this.joy2Read()|h)&0xFFFF}else{return this.joy2Read()}}break}return 0},regWrite:function(a,b){switch(a){case 0x2000:this.nes.cpu.mem[a]=b;this.nes.ppu.updateControlReg1(b);break;case 0x2001:this.nes.cpu.mem[a]=b;this.nes.ppu.updateControlReg2(b);break;case 0x2003:this.nes.ppu.writeSRAMAddress(b);break;case 0x2004:this.nes.ppu.sramWrite(b);break;case 0x2005:this.nes.ppu.scrollWrite(b);break;case 0x2006:this.nes.ppu.writeVRAMAddress(b);break;case 0x2007:this.nes.ppu.vramWrite(b);break;case 0x4014:this.nes.ppu.sramDMA(b);break;case 0x4015:this.nes.papu.writeReg(a,b);break;case 0x4016:if(b===0&&this.joypadLastWrite===1){this.joy1StrobeState=0;this.joy2StrobeState=0}this.joypadLastWrite=b;break;case 0x4017:this.nes.papu.writeReg(a,b);break;default:if(a>=0x4000&&a<=0x4017){this.nes.papu.writeReg(a,b)}}},joy1Read:function(){var a;switch(this.joy1StrobeState){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a=this.nes.keyboard.state1[this.joy1StrobeState];break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:a=0;break;case 19:a=1;break;default:a=0}this.joy1StrobeState++;if(this.joy1StrobeState==24){this.joy1StrobeState=0}return a},joy2Read:function(){var a;switch(this.joy2StrobeState){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a=this.nes.keyboard.state2[this.joy2StrobeState];break;case 8:case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:a=0;break;case 19:a=1;break;default:a=0}this.joy2StrobeState++;if(this.joy2StrobeState==24){this.joy2StrobeState=0}return a},loadROM:function(){if(!this.nes.rom.valid||this.nes.rom.romCount<1){alert("NoMapper: Invalid ROM! Unable to load.");return}this.loadPRGROM();this.loadCHRROM();this.loadBatteryRam();this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)},loadPRGROM:function(){if(this.nes.rom.romCount>1){this.loadRomBank(0,0x8000);this.loadRomBank(1,0xC000)}else{this.loadRomBank(0,0x8000);this.loadRomBank(0,0xC000)}},loadCHRROM:function(){if(this.nes.rom.vromCount>0){if(this.nes.rom.vromCount==1){this.loadVromBank(0,0x0000);this.loadVromBank(0,0x1000)}else{this.loadVromBank(0,0x0000);this.loadVromBank(1,0x1000)}}else{}},loadBatteryRam:function(){if(this.nes.rom.batteryRam){var a=this.nes.rom.batteryRam;if(a!==null&&a.length==0x2000){JSNES.Utils.copyArrayElements(a,0,this.nes.cpu.mem,0x6000,0x2000)}}},loadRomBank:function(a,b){a%=this.nes.rom.romCount;JSNES.Utils.copyArrayElements(this.nes.rom.rom[a],0,this.nes.cpu.mem,b,16384)},loadVromBank:function(a,b){if(this.nes.rom.vromCount===0){return}this.nes.ppu.triggerRendering();JSNES.Utils.copyArrayElements(this.nes.rom.vrom[a%this.nes.rom.vromCount],0,this.nes.ppu.vramMem,b,4096);var c=this.nes.rom.vromTile[a%this.nes.rom.vromCount];JSNES.Utils.copyArrayElements(c,0,this.nes.ppu.ptTile,b>>4,256)},load32kRomBank:function(a,b){this.loadRomBank((a*2)%this.nes.rom.romCount,b);this.loadRomBank((a*2+1)%this.nes.rom.romCount,b+16384)},load8kVromBank:function(a,b){if(this.nes.rom.vromCount===0){return}this.nes.ppu.triggerRendering();this.loadVromBank((a)%this.nes.rom.vromCount,b);this.loadVromBank((a+1)%this.nes.rom.vromCount,b+4096)},load1kVromBank:function(a,b){if(this.nes.rom.vromCount===0){return}this.nes.ppu.triggerRendering();var c=Math.floor(a/4)%this.nes.rom.vromCount;var d=(a%4)*1024;JSNES.Utils.copyArrayElements(this.nes.rom.vrom[c],0,this.nes.ppu.vramMem,d,1024);var g=this.nes.rom.vromTile[c];var h=b>>4;for(var f=0;f<64;f++){this.nes.ppu.ptTile[h+f]=g[((a%4)<<6)+f]}},load2kVromBank:function(a,b){if(this.nes.rom.vromCount===0){return}this.nes.ppu.triggerRendering();var c=Math.floor(a/2)%this.nes.rom.vromCount;var d=(a%2)*2048;JSNES.Utils.copyArrayElements(this.nes.rom.vrom[c],d,this.nes.ppu.vramMem,b,2048);var g=this.nes.rom.vromTile[c];var h=b>>4;for(var f=0;f<128;f++){this.nes.ppu.ptTile[h+f]=g[((a%2)<<7)+f]}},load8kRomBank:function(a,b){var c=Math.floor(a/2)%this.nes.rom.romCount;var d=(a%2)*8192;JSNES.Utils.copyArrayElements(this.nes.rom.rom[c],d,this.nes.cpu.mem,b,8192)},clockIrqCounter:function(){},latchAccess:function(a){},toJSON:function(){return{'joy1StrobeState':this.joy1StrobeState,'joy2StrobeState':this.joy2StrobeState,'joypadLastWrite':this.joypadLastWrite}},fromJSON:function(a){this.joy1StrobeState=a.joy1StrobeState;this.joy2StrobeState=a.joy2StrobeState;this.joypadLastWrite=a.joypadLastWrite}};JSNES.Mappers[1]=function(a){this.nes=a};JSNES.Mappers[1].prototype=new JSNES.Mappers[0]();JSNES.Mappers[1].prototype.reset=function(){JSNES.Mappers[0].prototype.reset.apply(this);this.regBuffer=0;this.regBufferCounter=0;this.mirroring=0;this.oneScreenMirroring=0;this.prgSwitchingArea=1;this.prgSwitchingSize=1;this.vromSwitchingSize=0;this.romSelectionReg0=0;this.romSelectionReg1=0;this.romBankSelect=0};JSNES.Mappers[1].prototype.write=function(a,b){if(a<0x8000){JSNES.Mappers[0].prototype.write.apply(this,arguments);return}if((b&128)!==0){this.regBufferCounter=0;this.regBuffer=0;if(this.getRegNumber(a)===0){this.prgSwitchingArea=1;this.prgSwitchingSize=1}}else{this.regBuffer=(this.regBuffer&(0xFF-(1<<this.regBufferCounter)))|((b&1)<<this.regBufferCounter);this.regBufferCounter++;if(this.regBufferCounter==5){this.setReg(this.getRegNumber(a),this.regBuffer);this.regBuffer=0;this.regBufferCounter=0}}};JSNES.Mappers[1].prototype.setReg=function(a,b){var c;switch(a){case 0:c=b&3;if(c!==this.mirroring){this.mirroring=c;if((this.mirroring&2)===0){this.nes.ppu.setMirroring(this.nes.rom.SINGLESCREEN_MIRRORING)}else if((this.mirroring&1)!==0){this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING)}else{this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING)}}this.prgSwitchingArea=(b>>2)&1;this.prgSwitchingSize=(b>>3)&1;this.vromSwitchingSize=(b>>4)&1;break;case 1:this.romSelectionReg0=(b>>4)&1;if(this.nes.rom.vromCount>0){if(this.vromSwitchingSize===0){if(this.romSelectionReg0===0){this.load8kVromBank((b&0xF),0x0000)}else{this.load8kVromBank(Math.floor(this.nes.rom.vromCount/2)+(b&0xF),0x0000)}}else{if(this.romSelectionReg0===0){this.loadVromBank((b&0xF),0x0000)}else{this.loadVromBank(Math.floor(this.nes.rom.vromCount/2)+(b&0xF),0x0000)}}}break;case 2:this.romSelectionReg1=(b>>4)&1;if(this.nes.rom.vromCount>0){if(this.vromSwitchingSize===1){if(this.romSelectionReg1===0){this.loadVromBank((b&0xF),0x1000)}else{this.loadVromBank(Math.floor(this.nes.rom.vromCount/2)+(b&0xF),0x1000)}}}break;default:c=b&0xF;var d;var g=0;if(this.nes.rom.romCount>=32){if(this.vromSwitchingSize===0){if(this.romSelectionReg0===1){g=16}}else{g=(this.romSelectionReg0|(this.romSelectionReg1<<1))<<3}}else if(this.nes.rom.romCount>=16){if(this.romSelectionReg0===1){g=8}}if(this.prgSwitchingSize===0){d=g+(b&0xF);this.load32kRomBank(d,0x8000)}else{d=g*2+(b&0xF);if(this.prgSwitchingArea===0){this.loadRomBank(d,0xC000)}else{this.loadRomBank(d,0x8000)}}}};JSNES.Mappers[1].prototype.getRegNumber=function(a){if(a>=0x8000&&a<=0x9FFF){return 0}else if(a>=0xA000&&a<=0xBFFF){return 1}else if(a>=0xC000&&a<=0xDFFF){return 2}else{return 3}};JSNES.Mappers[1].prototype.loadROM=function(a){if(!this.nes.rom.valid){alert("MMC1: Invalid ROM! Unable to load.");return}this.loadRomBank(0,0x8000);this.loadRomBank(this.nes.rom.romCount-1,0xC000);this.loadCHRROM();this.loadBatteryRam();this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)};JSNES.Mappers[1].prototype.switchLowHighPrgRom=function(a){};JSNES.Mappers[1].prototype.switch16to32=function(){};JSNES.Mappers[1].prototype.switch32to16=function(){};JSNES.Mappers[1].prototype.toJSON=function(){var a=JSNES.Mappers[0].prototype.toJSON.apply(this);a.mirroring=this.mirroring;a.oneScreenMirroring=this.oneScreenMirroring;a.prgSwitchingArea=this.prgSwitchingArea;a.prgSwitchingSize=this.prgSwitchingSize;a.vromSwitchingSize=this.vromSwitchingSize;a.romSelectionReg0=this.romSelectionReg0;a.romSelectionReg1=this.romSelectionReg1;a.romBankSelect=this.romBankSelect;a.regBuffer=this.regBuffer;a.regBufferCounter=this.regBufferCounter;return a};JSNES.Mappers[1].prototype.fromJSON=function(a){JSNES.Mappers[0].prototype.fromJSON.apply(this,a);this.mirroring=a.mirroring;this.oneScreenMirroring=a.oneScreenMirroring;this.prgSwitchingArea=a.prgSwitchingArea;this.prgSwitchingSize=a.prgSwitchingSize;this.vromSwitchingSize=a.vromSwitchingSize;this.romSelectionReg0=a.romSelectionReg0;this.romSelectionReg1=a.romSelectionReg1;this.romBankSelect=a.romBankSelect;this.regBuffer=a.regBuffer;this.regBufferCounter=a.regBufferCounter};JSNES.Mappers[2]=function(a){this.nes=a};JSNES.Mappers[2].prototype=new JSNES.Mappers[0]();JSNES.Mappers[2].prototype.write=function(a,b){if(a<0x8000){JSNES.Mappers[0].prototype.write.apply(this,arguments);return}else{this.loadRomBank(b,0x8000)}};JSNES.Mappers[2].prototype.loadROM=function(a){if(!this.nes.rom.valid){alert("UNROM: Invalid ROM! Unable to load.");return}this.loadRomBank(0,0x8000);this.loadRomBank(this.nes.rom.romCount-1,0xC000);this.loadCHRROM();this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)};JSNES.Mappers[4]=function(a){this.nes=a;this.CMD_SEL_2_1K_VROM_0000=0;this.CMD_SEL_2_1K_VROM_0800=1;this.CMD_SEL_1K_VROM_1000=2;this.CMD_SEL_1K_VROM_1400=3;this.CMD_SEL_1K_VROM_1800=4;this.CMD_SEL_1K_VROM_1C00=5;this.CMD_SEL_ROM_PAGE1=6;this.CMD_SEL_ROM_PAGE2=7;this.command=null;this.prgAddressSelect=null;this.chrAddressSelect=null;this.pageNumber=null;this.irqCounter=null;this.irqLatchValue=null;this.irqEnable=null;this.prgAddressChanged=false};JSNES.Mappers[4].prototype=new JSNES.Mappers[0]();JSNES.Mappers[4].prototype.write=function(a,b){if(a<0x8000){JSNES.Mappers[0].prototype.write.apply(this,arguments);return}switch(a){case 0x8000:this.command=b&7;var c=(b>>6)&1;if(c!=this.prgAddressSelect){this.prgAddressChanged=true}this.prgAddressSelect=c;this.chrAddressSelect=(b>>7)&1;break;case 0x8001:this.executeCommand(this.command,b);break;case 0xA000:if((b&1)!==0){this.nes.ppu.setMirroring(this.nes.rom.HORIZONTAL_MIRRORING)}else{this.nes.ppu.setMirroring(this.nes.rom.VERTICAL_MIRRORING)}break;case 0xA001:break;case 0xC000:this.irqCounter=b;break;case 0xC001:this.irqLatchValue=b;break;case 0xE000:this.irqEnable=0;break;case 0xE001:this.irqEnable=1;break;default:}};JSNES.Mappers[4].prototype.executeCommand=function(a,b){switch(a){case this.CMD_SEL_2_1K_VROM_0000:if(this.chrAddressSelect===0){this.load1kVromBank(b,0x0000);this.load1kVromBank(b+1,0x0400)}else{this.load1kVromBank(b,0x1000);this.load1kVromBank(b+1,0x1400)}break;case this.CMD_SEL_2_1K_VROM_0800:if(this.chrAddressSelect===0){this.load1kVromBank(b,0x0800);this.load1kVromBank(b+1,0x0C00)}else{this.load1kVromBank(b,0x1800);this.load1kVromBank(b+1,0x1C00)}break;case this.CMD_SEL_1K_VROM_1000:if(this.chrAddressSelect===0){this.load1kVromBank(b,0x1000)}else{this.load1kVromBank(b,0x0000)}break;case this.CMD_SEL_1K_VROM_1400:if(this.chrAddressSelect===0){this.load1kVromBank(b,0x1400)}else{this.load1kVromBank(b,0x0400)}break;case this.CMD_SEL_1K_VROM_1800:if(this.chrAddressSelect===0){this.load1kVromBank(b,0x1800)}else{this.load1kVromBank(b,0x0800)}break;case this.CMD_SEL_1K_VROM_1C00:if(this.chrAddressSelect===0){this.load1kVromBank(b,0x1C00)}else{this.load1kVromBank(b,0x0C00)}break;case this.CMD_SEL_ROM_PAGE1:if(this.prgAddressChanged){if(this.prgAddressSelect===0){this.load8kRomBank(((this.nes.rom.romCount-1)*2),0xC000)}else{this.load8kRomBank(((this.nes.rom.romCount-1)*2),0x8000)}this.prgAddressChanged=false}if(this.prgAddressSelect===0){this.load8kRomBank(b,0x8000)}else{this.load8kRomBank(b,0xC000)}break;case this.CMD_SEL_ROM_PAGE2:this.load8kRomBank(b,0xA000);if(this.prgAddressChanged){if(this.prgAddressSelect===0){this.load8kRomBank(((this.nes.rom.romCount-1)*2),0xC000)}else{this.load8kRomBank(((this.nes.rom.romCount-1)*2),0x8000)}this.prgAddressChanged=false}}};JSNES.Mappers[4].prototype.loadROM=function(a){if(!this.nes.rom.valid){alert("MMC3: Invalid ROM! Unable to load.");return}this.load8kRomBank(((this.nes.rom.romCount-1)*2),0xC000);this.load8kRomBank(((this.nes.rom.romCount-1)*2)+1,0xE000);this.load8kRomBank(0,0x8000);this.load8kRomBank(1,0xA000);this.loadCHRROM();this.loadBatteryRam();this.nes.cpu.requestIrq(this.nes.cpu.IRQ_RESET)};JSNES.Mappers[4].prototype.clockIrqCounter=function(){if(this.irqEnable==1){this.irqCounter--;if(this.irqCounter<0){this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL);this.irqCounter=this.irqLatchValue}}};JSNES.Mappers[4].prototype.toJSON=function(){var a=JSNES.Mappers[0].prototype.toJSON.apply(this);a.command=this.command;a.prgAddressSelect=this.prgAddressSelect;a.chrAddressSelect=this.chrAddressSelect;a.pageNumber=this.pageNumber;a.irqCounter=this.irqCounter;a.irqLatchValue=this.irqLatchValue;a.irqEnable=this.irqEnable;a.prgAddressChanged=this.prgAddressChanged;return a};JSNES.Mappers[4].prototype.fromJSON=function(a){JSNES.Mappers[0].prototype.fromJSON.apply(this,a);this.command=a.command;this.prgAddressSelect=a.prgAddressSelect;this.chrAddressSelect=a.chrAddressSelect;this.pageNumber=a.pageNumber;this.irqCounter=a.irqCounter;this.irqLatchValue=a.irqLatchValue;this.irqEnable=a.irqEnable;this.prgAddressChanged=a.prgAddressChanged};JSNES.PAPU=function(a){this.nes=a;this.square1=new JSNES.PAPU.ChannelSquare(this,true);this.square2=new JSNES.PAPU.ChannelSquare(this,false);this.triangle=new JSNES.PAPU.ChannelTriangle(this);this.noise=new JSNES.PAPU.ChannelNoise(this);this.dmc=new JSNES.PAPU.ChannelDM(this);this.frameIrqCounter=null;this.frameIrqCounterMax=4;this.initCounter=2048;this.channelEnableValue=null;this.bufferSize=8192;this.bufferIndex=0;this.sampleRate=44100;this.lengthLookup=null;this.dmcFreqLookup=null;this.noiseWavelengthLookup=null;this.square_table=null;this.tnd_table=null;this.sampleBuffer=new Array(this.bufferSize*2);this.frameIrqEnabled=false;this.frameIrqActive=null;this.frameClockNow=null;this.startedPlaying=false;this.recordOutput=false;this.initingHardware=false;this.masterFrameCounter=null;this.derivedFrameCounter=null;this.countSequence=null;this.sampleTimer=null;this.frameTime=null;this.sampleTimerMax=null;this.sampleCount=null;this.triValue=0;this.smpSquare1=null;this.smpSquare2=null;this.smpTriangle=null;this.smpDmc=null;this.accCount=null;this.prevSampleL=0;this.prevSampleR=0;this.smpAccumL=0;this.smpAccumR=0;this.dacRange=0;this.dcValue=0;this.masterVolume=256;this.stereoPosLSquare1=null;this.stereoPosLSquare2=null;this.stereoPosLTriangle=null;this.stereoPosLNoise=null;this.stereoPosLDMC=null;this.stereoPosRSquare1=null;this.stereoPosRSquare2=null;this.stereoPosRTriangle=null;this.stereoPosRNoise=null;this.stereoPosRDMC=null;this.extraCycles=null;this.maxSample=null;this.minSample=null;this.panning=[80,170,100,150,128];this.setPanning(this.panning);this.initLengthLookup();this.initDmcFrequencyLookup();this.initNoiseWavelengthLookup();this.initDACtables();for(var b=0;b<0x14;b++){if(b===0x10){this.writeReg(0x4010,0x10)}else{this.writeReg(0x4000+b,0)}}this.reset()};JSNES.PAPU.prototype={reset:function(){this.sampleRate=this.nes.opts.sampleRate;this.sampleTimerMax=Math.floor((1024.0*this.nes.opts.CPU_FREQ_NTSC*this.nes.opts.preferredFrameRate)/(this.sampleRate*60.0));this.frameTime=Math.floor((14915.0*this.nes.opts.preferredFrameRate)/60.0);this.sampleTimer=0;this.bufferIndex=0;this.updateChannelEnable(0);this.masterFrameCounter=0;this.derivedFrameCounter=0;this.countSequence=0;this.sampleCount=0;this.initCounter=2048;this.frameIrqEnabled=false;this.initingHardware=false;this.resetCounter();this.square1.reset();this.square2.reset();this.triangle.reset();this.noise.reset();this.dmc.reset();this.bufferIndex=0;this.accCount=0;this.smpSquare1=0;this.smpSquare2=0;this.smpTriangle=0;this.smpDmc=0;this.frameIrqEnabled=false;this.frameIrqCounterMax=4;this.channelEnableValue=0xFF;this.startedPlaying=false;this.prevSampleL=0;this.prevSampleR=0;this.smpAccumL=0;this.smpAccumR=0;this.maxSample=-500000;this.minSample=500000},readReg:function(a){var b=0;b|=(this.square1.getLengthStatus());b|=(this.square2.getLengthStatus()<<1);b|=(this.triangle.getLengthStatus()<<2);b|=(this.noise.getLengthStatus()<<3);b|=(this.dmc.getLengthStatus()<<4);b|=(((this.frameIrqActive&&this.frameIrqEnabled)?1:0)<<6);b|=(this.dmc.getIrqStatus()<<7);this.frameIrqActive=false;this.dmc.irqGenerated=false;return b&0xFFFF},writeReg:function(a,b){if(a>=0x4000&&a<0x4004){this.square1.writeReg(a,b)}else if(a>=0x4004&&a<0x4008){this.square2.writeReg(a,b)}else if(a>=0x4008&&a<0x400C){this.triangle.writeReg(a,b)}else if(a>=0x400C&&a<=0x400F){this.noise.writeReg(a,b)}else if(a===0x4010){this.dmc.writeReg(a,b)}else if(a===0x4011){this.dmc.writeReg(a,b)}else if(a===0x4012){this.dmc.writeReg(a,b)}else if(a===0x4013){this.dmc.writeReg(a,b)}else if(a===0x4015){this.updateChannelEnable(b);if(b!==0&&this.initCounter>0){this.initingHardware=true}this.dmc.writeReg(a,b)}else if(a===0x4017){this.countSequence=(b>>7)&1;this.masterFrameCounter=0;this.frameIrqActive=false;if(((b>>6)&0x1)===0){this.frameIrqEnabled=true}else{this.frameIrqEnabled=false}if(this.countSequence===0){this.frameIrqCounterMax=4;this.derivedFrameCounter=4}else{this.frameIrqCounterMax=5;this.derivedFrameCounter=0;this.frameCounterTick()}}},resetCounter:function(){if(this.countSequence===0){this.derivedFrameCounter=4}else{this.derivedFrameCounter=0}},updateChannelEnable:function(a){this.channelEnableValue=a&0xFFFF;this.square1.setEnabled((a&1)!==0);this.square2.setEnabled((a&2)!==0);this.triangle.setEnabled((a&4)!==0);this.noise.setEnabled((a&8)!==0);this.dmc.setEnabled((a&16)!==0)},clockFrameCounter:function(a){if(this.initCounter>0){if(this.initingHardware){this.initCounter-=a;if(this.initCounter<=0){this.initingHardware=false}return}}a+=this.extraCycles;var b=this.sampleTimerMax-this.sampleTimer;if((a<<10)>b){this.extraCycles=((a<<10)-b)>>10;a-=this.extraCycles}else{this.extraCycles=0}var c=this.dmc;var d=this.triangle;var g=this.square1;var h=this.square2;var f=this.noise;if(c.isEnabled){c.shiftCounter-=(a<<3);while(c.shiftCounter<=0&&c.dmaFrequency>0){c.shiftCounter+=c.dmaFrequency;c.clockDmc()}}if(d.progTimerMax>0){d.progTimerCount-=a;while(d.progTimerCount<=0){d.progTimerCount+=d.progTimerMax+1;if(d.linearCounter>0&&d.lengthCounter>0){d.triangleCounter++;d.triangleCounter&=0x1F;if(d.isEnabled){if(d.triangleCounter>=0x10){d.sampleValue=(d.triangleCounter&0xF)}else{d.sampleValue=(0xF-(d.triangleCounter&0xF))}d.sampleValue<<=4}}}}g.progTimerCount-=a;if(g.progTimerCount<=0){g.progTimerCount+=(g.progTimerMax+1)<<1;g.squareCounter++;g.squareCounter&=0x7;g.updateSampleValue()}h.progTimerCount-=a;if(h.progTimerCount<=0){h.progTimerCount+=(h.progTimerMax+1)<<1;h.squareCounter++;h.squareCounter&=0x7;h.updateSampleValue()}var e=a;if(f.progTimerCount-e>0){f.progTimerCount-=e;f.accCount+=e;f.accValue+=e*f.sampleValue}else{while((e--)>0){if(--f.progTimerCount<=0&&f.progTimerMax>0){f.shiftReg<<=1;f.tmp=(((f.shiftReg<<(f.randomMode===0?1:6))^f.shiftReg)&0x8000);if(f.tmp!==0){f.shiftReg|=0x01;f.randomBit=0;f.sampleValue=0}else{f.randomBit=1;if(f.isEnabled&&f.lengthCounter>0){f.sampleValue=f.masterVolume}else{f.sampleValue=0}}f.progTimerCount+=f.progTimerMax}f.accValue+=f.sampleValue;f.accCount++}}if(this.frameIrqEnabled&&this.frameIrqActive){this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NORMAL)}this.masterFrameCounter+=(a<<1);if(this.masterFrameCounter>=this.frameTime){this.masterFrameCounter-=this.frameTime;this.frameCounterTick()}this.accSample(a);this.sampleTimer+=a<<10;if(this.sampleTimer>=this.sampleTimerMax){this.sample();this.sampleTimer-=this.sampleTimerMax}},accSample:function(a){if(this.triangle.sampleCondition){this.triValue=Math.floor((this.triangle.progTimerCount<<4)/(this.triangle.progTimerMax+1));if(this.triValue>16){this.triValue=16}if(this.triangle.triangleCounter>=16){this.triValue=16-this.triValue}this.triValue+=this.triangle.sampleValue}if(a===2){this.smpTriangle+=this.triValue<<1;this.smpDmc+=this.dmc.sample<<1;this.smpSquare1+=this.square1.sampleValue<<1;this.smpSquare2+=this.square2.sampleValue<<1;this.accCount+=2}else if(a===4){this.smpTriangle+=this.triValue<<2;this.smpDmc+=this.dmc.sample<<2;this.smpSquare1+=this.square1.sampleValue<<2;this.smpSquare2+=this.square2.sampleValue<<2;this.accCount+=4}else{this.smpTriangle+=a*this.triValue;this.smpDmc+=a*this.dmc.sample;this.smpSquare1+=a*this.square1.sampleValue;this.smpSquare2+=a*this.square2.sampleValue;this.accCount+=a}},frameCounterTick:function(){this.derivedFrameCounter++;if(this.derivedFrameCounter>=this.frameIrqCounterMax){this.derivedFrameCounter=0}if(this.derivedFrameCounter===1||this.derivedFrameCounter===3){this.triangle.clockLengthCounter();this.square1.clockLengthCounter();this.square2.clockLengthCounter();this.noise.clockLengthCounter();this.square1.clockSweep();this.square2.clockSweep()}if(this.derivedFrameCounter>=0&&this.derivedFrameCounter<4){this.square1.clockEnvDecay();this.square2.clockEnvDecay();this.noise.clockEnvDecay();this.triangle.clockLinearCounter()}if(this.derivedFrameCounter===3&&this.countSequence===0){this.frameIrqActive=true}},sample:function(){var a,b;if(this.accCount>0){this.smpSquare1<<=4;this.smpSquare1=Math.floor(this.smpSquare1/this.accCount);this.smpSquare2<<=4;this.smpSquare2=Math.floor(this.smpSquare2/this.accCount);this.smpTriangle=Math.floor(this.smpTriangle/this.accCount);this.smpDmc<<=4;this.smpDmc=Math.floor(this.smpDmc/this.accCount);this.accCount=0}else{this.smpSquare1=this.square1.sampleValue<<4;this.smpSquare2=this.square2.sampleValue<<4;this.smpTriangle=this.triangle.sampleValue;this.smpDmc=this.dmc.sample<<4}var c=Math.floor((this.noise.accValue<<4)/this.noise.accCount);this.noise.accValue=c>>4;this.noise.accCount=1;a=(this.smpSquare1*this.stereoPosLSquare1+this.smpSquare2*this.stereoPosLSquare2)>>8;b=(3*this.smpTriangle*this.stereoPosLTriangle+(c<<1)*this.stereoPosLNoise+this.smpDmc*this.stereoPosLDMC)>>8;if(a>=this.square_table.length){a=this.square_table.length-1}if(b>=this.tnd_table.length){b=this.tnd_table.length-1}var d=this.square_table[a]+this.tnd_table[b]-this.dcValue;a=(this.smpSquare1*this.stereoPosRSquare1+this.smpSquare2*this.stereoPosRSquare2)>>8;b=(3*this.smpTriangle*this.stereoPosRTriangle+(c<<1)*this.stereoPosRNoise+this.smpDmc*this.stereoPosRDMC)>>8;if(a>=this.square_table.length){a=this.square_table.length-1}if(b>=this.tnd_table.length){b=this.tnd_table.length-1}var g=this.square_table[a]+this.tnd_table[b]-this.dcValue;var h=d-this.prevSampleL;this.prevSampleL+=h;this.smpAccumL+=h-(this.smpAccumL>>10);d=this.smpAccumL;var f=g-this.prevSampleR;this.prevSampleR+=f;this.smpAccumR+=f-(this.smpAccumR>>10);g=this.smpAccumR;if(d>this.maxSample){this.maxSample=d}if(d<this.minSample){this.minSample=d}this.sampleBuffer[this.bufferIndex++]=d;this.sampleBuffer[this.bufferIndex++]=g;if(this.bufferIndex===this.sampleBuffer.length){this.nes.ui.writeAudio(this.sampleBuffer);this.sampleBuffer=new Array(this.bufferSize*2);this.bufferIndex=0}this.smpSquare1=0;this.smpSquare2=0;this.smpTriangle=0;this.smpDmc=0},getLengthMax:function(a){return this.lengthLookup[a>>3]},getDmcFrequency:function(a){if(a>=0&&a<0x10){return this.dmcFreqLookup[a]}return 0},getNoiseWaveLength:function(a){if(a>=0&&a<0x10){return this.noiseWavelengthLookup[a]}return 0},setPanning:function(a){for(var b=0;b<5;b++){this.panning[b]=a[b]}this.updateStereoPos()},setMasterVolume:function(a){if(a<0){a=0}if(a>256){a=256}this.masterVolume=a;this.updateStereoPos()},updateStereoPos:function(){this.stereoPosLSquare1=(this.panning[0]*this.masterVolume)>>8;this.stereoPosLSquare2=(this.panning[1]*this.masterVolume)>>8;this.stereoPosLTriangle=(this.panning[2]*this.masterVolume)>>8;this.stereoPosLNoise=(this.panning[3]*this.masterVolume)>>8;this.stereoPosLDMC=(this.panning[4]*this.masterVolume)>>8;this.stereoPosRSquare1=this.masterVolume-this.stereoPosLSquare1;this.stereoPosRSquare2=this.masterVolume-this.stereoPosLSquare2;this.stereoPosRTriangle=this.masterVolume-this.stereoPosLTriangle;this.stereoPosRNoise=this.masterVolume-this.stereoPosLNoise;this.stereoPosRDMC=this.masterVolume-this.stereoPosLDMC},initLengthLookup:function(){this.lengthLookup=[0x0A,0xFE,0x14,0x02,0x28,0x04,0x50,0x06,0xA0,0x08,0x3C,0x0A,0x0E,0x0C,0x1A,0x0E,0x0C,0x10,0x18,0x12,0x30,0x14,0x60,0x16,0xC0,0x18,0x48,0x1A,0x10,0x1C,0x20,0x1E]},initDmcFrequencyLookup:function(){this.dmcFreqLookup=new Array(16);this.dmcFreqLookup[0x0]=0xD60;this.dmcFreqLookup[0x1]=0xBE0;this.dmcFreqLookup[0x2]=0xAA0;this.dmcFreqLookup[0x3]=0xA00;this.dmcFreqLookup[0x4]=0x8F0;this.dmcFreqLookup[0x5]=0x7F0;this.dmcFreqLookup[0x6]=0x710;this.dmcFreqLookup[0x7]=0x6B0;this.dmcFreqLookup[0x8]=0x5F0;this.dmcFreqLookup[0x9]=0x500;this.dmcFreqLookup[0xA]=0x470;this.dmcFreqLookup[0xB]=0x400;this.dmcFreqLookup[0xC]=0x350;this.dmcFreqLookup[0xD]=0x2A0;this.dmcFreqLookup[0xE]=0x240;this.dmcFreqLookup[0xF]=0x1B0},initNoiseWavelengthLookup:function(){this.noiseWavelengthLookup=new Array(16);this.noiseWavelengthLookup[0x0]=0x004;this.noiseWavelengthLookup[0x1]=0x008;this.noiseWavelengthLookup[0x2]=0x010;this.noiseWavelengthLookup[0x3]=0x020;this.noiseWavelengthLookup[0x4]=0x040;this.noiseWavelengthLookup[0x5]=0x060;this.noiseWavelengthLookup[0x6]=0x080;this.noiseWavelengthLookup[0x7]=0x0A0;this.noiseWavelengthLookup[0x8]=0x0CA;this.noiseWavelengthLookup[0x9]=0x0FE;this.noiseWavelengthLookup[0xA]=0x17C;this.noiseWavelengthLookup[0xB]=0x1FC;this.noiseWavelengthLookup[0xC]=0x2FA;this.noiseWavelengthLookup[0xD]=0x3F8;this.noiseWavelengthLookup[0xE]=0x7F2;this.noiseWavelengthLookup[0xF]=0xFE4},initDACtables:function(){var a,b,c;var d=0;var g=0;this.square_table=new Array(32*16);this.tnd_table=new Array(204*16);for(c=0;c<32*16;c++){a=95.52/(8128.0/(c/16.0)+100.0);a*=0.98411;a*=50000.0;b=Math.floor(a);this.square_table[c]=b;if(b>d){d=b}}for(c=0;c<204*16;c++){a=163.67/(24329.0/(c/16.0)+100.0);a*=0.98411;a*=50000.0;b=Math.floor(a);this.tnd_table[c]=b;if(b>g){g=b}}this.dacRange=d+g;this.dcValue=this.dacRange/2}};JSNES.PAPU.ChannelDM=function(a){this.papu=a;this.MODE_NORMAL=0;this.MODE_LOOP=1;this.MODE_IRQ=2;this.isEnabled=null;this.hasSample=null;this.irqGenerated=false;this.playMode=null;this.dmaFrequency=null;this.dmaCounter=null;this.deltaCounter=null;this.playStartAddress=null;this.playAddress=null;this.playLength=null;this.playLengthCounter=null;this.shiftCounter=null;this.reg4012=null;this.reg4013=null;this.sample=null;this.dacLsb=null;this.data=null;this.reset()};JSNES.PAPU.ChannelDM.prototype={clockDmc:function(){if(this.hasSample){if((this.data&1)===0){if(this.deltaCounter>0){this.deltaCounter--}}else{if(this.deltaCounter<63){this.deltaCounter++}}this.sample=this.isEnabled?(this.deltaCounter<<1)+this.dacLsb:0;this.data>>=1}this.dmaCounter--;if(this.dmaCounter<=0){this.hasSample=false;this.endOfSample();this.dmaCounter=8}if(this.irqGenerated){this.papu.nes.cpu.requestIrq(this.papu.nes.cpu.IRQ_NORMAL)}},endOfSample:function(){if(this.playLengthCounter===0&&this.playMode===this.MODE_LOOP){this.playAddress=this.playStartAddress;this.playLengthCounter=this.playLength}if(this.playLengthCounter>0){this.nextSample();if(this.playLengthCounter===0){if(this.playMode===this.MODE_IRQ){this.irqGenerated=true}}}},nextSample:function(){this.data=this.papu.nes.mmap.load(this.playAddress);this.papu.nes.cpu.haltCycles(4);this.playLengthCounter--;this.playAddress++;if(this.playAddress>0xFFFF){this.playAddress=0x8000}this.hasSample=true},writeReg:function(a,b){if(a===0x4010){if((b>>6)===0){this.playMode=this.MODE_NORMAL}else if(((b>>6)&1)===1){this.playMode=this.MODE_LOOP}else if((b>>6)===2){this.playMode=this.MODE_IRQ}if((b&0x80)===0){this.irqGenerated=false}this.dmaFrequency=this.papu.getDmcFrequency(b&0xF)}else if(a===0x4011){this.deltaCounter=(b>>1)&63;this.dacLsb=b&1;this.sample=((this.deltaCounter<<1)+this.dacLsb)}else if(a===0x4012){this.playStartAddress=(b<<6)|0x0C000;this.playAddress=this.playStartAddress;this.reg4012=b}else if(a===0x4013){this.playLength=(b<<4)+1;this.playLengthCounter=this.playLength;this.reg4013=b}else if(a===0x4015){if(((b>>4)&1)===0){this.playLengthCounter=0}else{this.playAddress=this.playStartAddress;this.playLengthCounter=this.playLength}this.irqGenerated=false}},setEnabled:function(a){if((!this.isEnabled)&&a){this.playLengthCounter=this.playLength}this.isEnabled=a},getLengthStatus:function(){return((this.playLengthCounter===0||!this.isEnabled)?0:1)},getIrqStatus:function(){return(this.irqGenerated?1:0)},reset:function(){this.isEnabled=false;this.irqGenerated=false;this.playMode=this.MODE_NORMAL;this.dmaFrequency=0;this.dmaCounter=0;this.deltaCounter=0;this.playStartAddress=0;this.playAddress=0;this.playLength=0;this.playLengthCounter=0;this.sample=0;this.dacLsb=0;this.shiftCounter=0;this.reg4012=0;this.reg4013=0;this.data=0}};JSNES.PAPU.ChannelNoise=function(a){this.papu=a;this.isEnabled=null;this.envDecayDisable=null;this.envDecayLoopEnable=null;this.lengthCounterEnable=null;this.envReset=null;this.shiftNow=null;this.lengthCounter=null;this.progTimerCount=null;this.progTimerMax=null;this.envDecayRate=null;this.envDecayCounter=null;this.envVolume=null;this.masterVolume=null;this.shiftReg=1<<14;this.randomBit=null;this.randomMode=null;this.sampleValue=null;this.accValue=0;this.accCount=1;this.tmp=null;this.reset()};JSNES.PAPU.ChannelNoise.prototype={reset:function(){this.progTimerCount=0;this.progTimerMax=0;this.isEnabled=false;this.lengthCounter=0;this.lengthCounterEnable=false;this.envDecayDisable=false;this.envDecayLoopEnable=false;this.shiftNow=false;this.envDecayRate=0;this.envDecayCounter=0;this.envVolume=0;this.masterVolume=0;this.shiftReg=1;this.randomBit=0;this.randomMode=0;this.sampleValue=0;this.tmp=0},clockLengthCounter:function(){if(this.lengthCounterEnable&&this.lengthCounter>0){this.lengthCounter--;if(this.lengthCounter===0){this.updateSampleValue()}}},clockEnvDecay:function(){if(this.envReset){this.envReset=false;this.envDecayCounter=this.envDecayRate+1;this.envVolume=0xF}else if(--this.envDecayCounter<=0){this.envDecayCounter=this.envDecayRate+1;if(this.envVolume>0){this.envVolume--}else{this.envVolume=this.envDecayLoopEnable?0xF:0}}this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume;this.updateSampleValue()},updateSampleValue:function(){if(this.isEnabled&&this.lengthCounter>0){this.sampleValue=this.randomBit*this.masterVolume}},writeReg:function(a,b){if(a===0x400C){this.envDecayDisable=((b&0x10)!==0);this.envDecayRate=b&0xF;this.envDecayLoopEnable=((b&0x20)!==0);this.lengthCounterEnable=((b&0x20)===0);this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume}else if(a===0x400E){this.progTimerMax=this.papu.getNoiseWaveLength(b&0xF);this.randomMode=b>>7}else if(a===0x400F){this.lengthCounter=this.papu.getLengthMax(b&248);this.envReset=true}},setEnabled:function(a){this.isEnabled=a;if(!a){this.lengthCounter=0}this.updateSampleValue()},getLengthStatus:function(){return((this.lengthCounter===0||!this.isEnabled)?0:1)}};JSNES.PAPU.ChannelSquare=function(a,b){this.papu=a;this.dutyLookup=[0,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,1,1,0,0,0,1,0,0,1,1,1,1,1];this.impLookup=[1,-1,0,0,0,0,0,0,1,0,-1,0,0,0,0,0,1,0,0,0,-1,0,0,0,-1,0,1,0,0,0,0,0];this.sqr1=b;this.isEnabled=null;this.lengthCounterEnable=null;this.sweepActive=null;this.envDecayDisable=null;this.envDecayLoopEnable=null;this.envReset=null;this.sweepCarry=null;this.updateSweepPeriod=null;this.progTimerCount=null;this.progTimerMax=null;this.lengthCounter=null;this.squareCounter=null;this.sweepCounter=null;this.sweepCounterMax=null;this.sweepMode=null;this.sweepShiftAmount=null;this.envDecayRate=null;this.envDecayCounter=null;this.envVolume=null;this.masterVolume=null;this.dutyMode=null;this.sweepResult=null;this.sampleValue=null;this.vol=null;this.reset()};JSNES.PAPU.ChannelSquare.prototype={reset:function(){this.progTimerCount=0;this.progTimerMax=0;this.lengthCounter=0;this.squareCounter=0;this.sweepCounter=0;this.sweepCounterMax=0;this.sweepMode=0;this.sweepShiftAmount=0;this.envDecayRate=0;this.envDecayCounter=0;this.envVolume=0;this.masterVolume=0;this.dutyMode=0;this.vol=0;this.isEnabled=false;this.lengthCounterEnable=false;this.sweepActive=false;this.sweepCarry=false;this.envDecayDisable=false;this.envDecayLoopEnable=false},clockLengthCounter:function(){if(this.lengthCounterEnable&&this.lengthCounter>0){this.lengthCounter--;if(this.lengthCounter===0){this.updateSampleValue()}}},clockEnvDecay:function(){if(this.envReset){this.envReset=false;this.envDecayCounter=this.envDecayRate+1;this.envVolume=0xF}else if((--this.envDecayCounter)<=0){this.envDecayCounter=this.envDecayRate+1;if(this.envVolume>0){this.envVolume--}else{this.envVolume=this.envDecayLoopEnable?0xF:0}}this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume;this.updateSampleValue()},clockSweep:function(){if(--this.sweepCounter<=0){this.sweepCounter=this.sweepCounterMax+1;if(this.sweepActive&&this.sweepShiftAmount>0&&this.progTimerMax>7){this.sweepCarry=false;if(this.sweepMode===0){this.progTimerMax+=(this.progTimerMax>>this.sweepShiftAmount);if(this.progTimerMax>4095){this.progTimerMax=4095;this.sweepCarry=true}}else{this.progTimerMax=this.progTimerMax-((this.progTimerMax>>this.sweepShiftAmount)-(this.sqr1?1:0))}}}if(this.updateSweepPeriod){this.updateSweepPeriod=false;this.sweepCounter=this.sweepCounterMax+1}},updateSampleValue:function(){if(this.isEnabled&&this.lengthCounter>0&&this.progTimerMax>7){if(this.sweepMode===0&&(this.progTimerMax+(this.progTimerMax>>this.sweepShiftAmount))>4095){this.sampleValue=0}else{this.sampleValue=this.masterVolume*this.dutyLookup[(this.dutyMode<<3)+this.squareCounter]}}else{this.sampleValue=0}},writeReg:function(a,b){var c=(this.sqr1?0:4);if(a===0x4000+c){this.envDecayDisable=((b&0x10)!==0);this.envDecayRate=b&0xF;this.envDecayLoopEnable=((b&0x20)!==0);this.dutyMode=(b>>6)&0x3;this.lengthCounterEnable=((b&0x20)===0);this.masterVolume=this.envDecayDisable?this.envDecayRate:this.envVolume;this.updateSampleValue()}else if(a===0x4001+c){this.sweepActive=((b&0x80)!==0);this.sweepCounterMax=((b>>4)&7);this.sweepMode=(b>>3)&1;this.sweepShiftAmount=b&7;this.updateSweepPeriod=true}else if(a===0x4002+c){this.progTimerMax&=0x700;this.progTimerMax|=b}else if(a===0x4003+c){this.progTimerMax&=0xFF;this.progTimerMax|=((b&0x7)<<8);if(this.isEnabled){this.lengthCounter=this.papu.getLengthMax(b&0xF8)}this.envReset=true}},setEnabled:function(a){this.isEnabled=a;if(!a){this.lengthCounter=0}this.updateSampleValue()},getLengthStatus:function(){return((this.lengthCounter===0||!this.isEnabled)?0:1)}};JSNES.PAPU.ChannelTriangle=function(a){this.papu=a;this.isEnabled=null;this.sampleCondition=null;this.lengthCounterEnable=null;this.lcHalt=null;this.lcControl=null;this.progTimerCount=null;this.progTimerMax=null;this.triangleCounter=null;this.lengthCounter=null;this.linearCounter=null;this.lcLoadValue=null;this.sampleValue=null;this.tmp=null;this.reset()};JSNES.PAPU.ChannelTriangle.prototype={reset:function(){this.progTimerCount=0;this.progTimerMax=0;this.triangleCounter=0;this.isEnabled=false;this.sampleCondition=false;this.lengthCounter=0;this.lengthCounterEnable=false;this.linearCounter=0;this.lcLoadValue=0;this.lcHalt=true;this.lcControl=false;this.tmp=0;this.sampleValue=0xF},clockLengthCounter:function(){if(this.lengthCounterEnable&&this.lengthCounter>0){this.lengthCounter--;if(this.lengthCounter===0){this.updateSampleCondition()}}},clockLinearCounter:function(){if(this.lcHalt){this.linearCounter=this.lcLoadValue;this.updateSampleCondition()}else if(this.linearCounter>0){this.linearCounter--;this.updateSampleCondition()}if(!this.lcControl){this.lcHalt=false}},getLengthStatus:function(){return((this.lengthCounter===0||!this.isEnabled)?0:1)},readReg:function(a){return 0},writeReg:function(a,b){if(a===0x4008){this.lcControl=(b&0x80)!==0;this.lcLoadValue=b&0x7F;this.lengthCounterEnable=!this.lcControl}else if(a===0x400A){this.progTimerMax&=0x700;this.progTimerMax|=b}else if(a===0x400B){this.progTimerMax&=0xFF;this.progTimerMax|=((b&0x07)<<8);this.lengthCounter=this.papu.getLengthMax(b&0xF8);this.lcHalt=true}this.updateSampleCondition()},clockProgrammableTimer:function(a){if(this.progTimerMax>0){this.progTimerCount+=a;while(this.progTimerMax>0&&this.progTimerCount>=this.progTimerMax){this.progTimerCount-=this.progTimerMax;if(this.isEnabled&&this.lengthCounter>0&&this.linearCounter>0){this.clockTriangleGenerator()}}}},clockTriangleGenerator:function(){this.triangleCounter++;this.triangleCounter&=0x1F},setEnabled:function(a){this.isEnabled=a;if(!a){this.lengthCounter=0}this.updateSampleCondition()},updateSampleCondition:function(){this.sampleCondition=this.isEnabled&&this.progTimerMax>7&&this.linearCounter>0&&this.lengthCounter>0}};JSNES.PPU=function(a){this.nes=a;this.vramMem=null;this.spriteMem=null;this.vramAddress=null;this.vramTmpAddress=null;this.vramBufferedReadValue=null;this.firstWrite=null;this.sramAddress=null;this.currentMirroring=null;this.requestEndFrame=null;this.nmiOk=null;this.dummyCycleToggle=null;this.validTileData=null;this.nmiCounter=null;this.scanlineAlreadyRendered=null;this.f_nmiOnVblank=null;this.f_spriteSize=null;this.f_bgPatternTable=null;this.f_spPatternTable=null;this.f_addrInc=null;this.f_nTblAddress=null;this.f_color=null;this.f_spVisibility=null;this.f_bgVisibility=null;this.f_spClipping=null;this.f_bgClipping=null;this.f_dispType=null;this.cntFV=null;this.cntV=null;this.cntH=null;this.cntVT=null;this.cntHT=null;this.regFV=null;this.regV=null;this.regH=null;this.regVT=null;this.regHT=null;this.regFH=null;this.regS=null;this.curNt=null;this.attrib=null;this.buffer=null;this.prevBuffer=null;this.bgbuffer=null;this.pixrendered=null;this.validTileData=null;this.scantile=null;this.scanline=null;this.lastRenderedScanline=null;this.curX=null;this.sprX=null;this.sprY=null;this.sprTile=null;this.sprCol=null;this.vertFlip=null;this.horiFlip=null;this.bgPriority=null;this.spr0HitX=null;this.spr0HitY=null;this.hitSpr0=null;this.sprPalette=null;this.imgPalette=null;this.ptTile=null;this.ntable1=null;this.currentMirroring=null;this.nameTable=null;this.vramMirrorTable=null;this.palTable=null;this.showSpr0Hit=false;this.clipToTvSize=true;this.reset()};JSNES.PPU.prototype={STATUS_VRAMWRITE:4,STATUS_SLSPRITECOUNT:5,STATUS_SPRITE0HIT:6,STATUS_VBLANK:7,reset:function(){var a;this.vramMem=new Array(0x8000);this.spriteMem=new Array(0x100);for(a=0;a<this.vramMem.length;a++){this.vramMem[a]=0}for(a=0;a<this.spriteMem.length;a++){this.spriteMem[a]=0}this.vramAddress=null;this.vramTmpAddress=null;this.vramBufferedReadValue=0;this.firstWrite=true;this.sramAddress=0;this.currentMirroring=-1;this.requestEndFrame=false;this.nmiOk=false;this.dummyCycleToggle=false;this.validTileData=false;this.nmiCounter=0;this.scanlineAlreadyRendered=null;this.f_nmiOnVblank=0;this.f_spriteSize=0;this.f_bgPatternTable=0;this.f_spPatternTable=0;this.f_addrInc=0;this.f_nTblAddress=0;this.f_color=0;this.f_spVisibility=0;this.f_bgVisibility=0;this.f_spClipping=0;this.f_bgClipping=0;this.f_dispType=0;this.cntFV=0;this.cntV=0;this.cntH=0;this.cntVT=0;this.cntHT=0;this.regFV=0;this.regV=0;this.regH=0;this.regVT=0;this.regHT=0;this.regFH=0;this.regS=0;this.curNt=null;this.attrib=new Array(32);this.buffer=new Array(256*240);this.prevBuffer=new Array(256*240);this.bgbuffer=new Array(256*240);this.pixrendered=new Array(256*240);this.validTileData=null;this.scantile=new Array(32);this.scanline=0;this.lastRenderedScanline=-1;this.curX=0;this.sprX=new Array(64);this.sprY=new Array(64);this.sprTile=new Array(64);this.sprCol=new Array(64);this.vertFlip=new Array(64);this.horiFlip=new Array(64);this.bgPriority=new Array(64);this.spr0HitX=0;this.spr0HitY=0;this.hitSpr0=false;this.sprPalette=new Array(16);this.imgPalette=new Array(16);this.ptTile=new Array(512);for(a=0;a<512;a++){this.ptTile[a]=new JSNES.PPU.Tile()}this.ntable1=new Array(4);this.currentMirroring=-1;this.nameTable=new Array(4);for(a=0;a<4;a++){this.nameTable[a]=new JSNES.PPU.NameTable(32,32,"Nt"+a)}this.vramMirrorTable=new Array(0x8000);for(a=0;a<0x8000;a++){this.vramMirrorTable[a]=a}this.palTable=new JSNES.PPU.PaletteTable();this.palTable.loadNTSCPalette();this.updateControlReg1(0);this.updateControlReg2(0)},setMirroring:function(a){if(a==this.currentMirroring){return}this.currentMirroring=a;this.triggerRendering();if(this.vramMirrorTable===null){this.vramMirrorTable=new Array(0x8000)}for(var b=0;b<0x8000;b++){this.vramMirrorTable[b]=b}this.defineMirrorRegion(0x3f20,0x3f00,0x20);this.defineMirrorRegion(0x3f40,0x3f00,0x20);this.defineMirrorRegion(0x3f80,0x3f00,0x20);this.defineMirrorRegion(0x3fc0,0x3f00,0x20);this.defineMirrorRegion(0x3000,0x2000,0xf00);this.defineMirrorRegion(0x4000,0x0000,0x4000);if(a==this.nes.rom.HORIZONTAL_MIRRORING){this.ntable1[0]=0;this.ntable1[1]=0;this.ntable1[2]=1;this.ntable1[3]=1;this.defineMirrorRegion(0x2400,0x2000,0x400);this.defineMirrorRegion(0x2c00,0x2800,0x400)}else if(a==this.nes.rom.VERTICAL_MIRRORING){this.ntable1[0]=0;this.ntable1[1]=1;this.ntable1[2]=0;this.ntable1[3]=1;this.defineMirrorRegion(0x2800,0x2000,0x400);this.defineMirrorRegion(0x2c00,0x2400,0x400)}else if(a==this.nes.rom.SINGLESCREEN_MIRRORING){this.ntable1[0]=0;this.ntable1[1]=0;this.ntable1[2]=0;this.ntable1[3]=0;this.defineMirrorRegion(0x2400,0x2000,0x400);this.defineMirrorRegion(0x2800,0x2000,0x400);this.defineMirrorRegion(0x2c00,0x2000,0x400)}else if(a==this.nes.rom.SINGLESCREEN_MIRRORING2){this.ntable1[0]=1;this.ntable1[1]=1;this.ntable1[2]=1;this.ntable1[3]=1;this.defineMirrorRegion(0x2400,0x2400,0x400);this.defineMirrorRegion(0x2800,0x2400,0x400);this.defineMirrorRegion(0x2c00,0x2400,0x400)}else{this.ntable1[0]=0;this.ntable1[1]=1;this.ntable1[2]=2;this.ntable1[3]=3}},defineMirrorRegion:function(a,b,c){for(var d=0;d<c;d++){this.vramMirrorTable[a+d]=b+d}},startVBlank:function(){this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NMI);if(this.lastRenderedScanline<239){this.renderFramePartially(this.lastRenderedScanline+1,240-this.lastRenderedScanline)}this.endFrame();this.lastRenderedScanline=-1},endScanline:function(){switch(this.scanline){case 19:if(this.dummyCycleToggle){this.curX=1;this.dummyCycleToggle=!this.dummyCycleToggle}break;case 20:this.setStatusFlag(this.STATUS_VBLANK,false);this.setStatusFlag(this.STATUS_SPRITE0HIT,false);this.hitSpr0=false;this.spr0HitX=-1;this.spr0HitY=-1;if(this.f_bgVisibility==1||this.f_spVisibility==1){this.cntFV=this.regFV;this.cntV=this.regV;this.cntH=this.regH;this.cntVT=this.regVT;this.cntHT=this.regHT;if(this.f_bgVisibility==1){this.renderBgScanline(false,0)}}if(this.f_bgVisibility==1&&this.f_spVisibility==1){this.checkSprite0(0)}if(this.f_bgVisibility==1||this.f_spVisibility==1){this.nes.mmap.clockIrqCounter()}break;case 261:this.setStatusFlag(this.STATUS_VBLANK,true);this.requestEndFrame=true;this.nmiCounter=9;this.scanline=-1;break;default:if(this.scanline>=21&&this.scanline<=260){if(this.f_bgVisibility==1){if(!this.scanlineAlreadyRendered){this.cntHT=this.regHT;this.cntH=this.regH;this.renderBgScanline(true,this.scanline+1-21)}this.scanlineAlreadyRendered=false;if(!this.hitSpr0&&this.f_spVisibility==1){if(this.sprX[0]>=-7&&this.sprX[0]<256&&this.sprY[0]+1<=(this.scanline-20)&&(this.sprY[0]+1+(this.f_spriteSize===0?8:16))>=(this.scanline-20)){if(this.checkSprite0(this.scanline-20)){this.hitSpr0=true}}}}if(this.f_bgVisibility==1||this.f_spVisibility==1){this.nes.mmap.clockIrqCounter()}}}this.scanline++;this.regsToAddress();this.cntsToAddress()},startFrame:function(){var a=0;if(this.f_dispType===0){a=this.imgPalette[0]}else{switch(this.f_color){case 0:a=0x00000;break;case 1:a=0x00FF00;break;case 2:a=0xFF0000;break;case 3:a=0x000000;break;case 4:a=0x0000FF;break;default:a=0x0}}var b=this.buffer;var c;for(c=0;c<256*240;c++){b[c]=a}var d=this.pixrendered;for(c=0;c<d.length;c++){d[c]=65}},endFrame:function(){var a,b,c;var d=this.buffer;if(this.showSpr0Hit){if(this.sprX[0]>=0&&this.sprX[0]<256&&this.sprY[0]>=0&&this.sprY[0]<240){for(a=0;a<256;a++){d[(this.sprY[0]<<8)+a]=0xFF5555}for(a=0;a<240;a++){d[(a<<8)+this.sprX[0]]=0xFF5555}}if(this.spr0HitX>=0&&this.spr0HitX<256&&this.spr0HitY>=0&&this.spr0HitY<240){for(a=0;a<256;a++){d[(this.spr0HitY<<8)+a]=0x55FF55}for(a=0;a<240;a++){d[(a<<8)+this.spr0HitX]=0x55FF55}}}if(this.clipToTvSize||this.f_bgClipping===0||this.f_spClipping===0){for(c=0;c<240;c++){for(b=0;b<8;b++){d[(c<<8)+b]=0}}}if(this.clipToTvSize){for(c=0;c<240;c++){for(b=0;b<8;b++){d[(c<<8)+255-b]=0}}}if(this.clipToTvSize){for(c=0;c<8;c++){for(b=0;b<256;b++){d[(c<<8)+b]=0;d[((239-c)<<8)+b]=0}}}if(this.nes.opts.showDisplay){this.nes.ui.writeFrame(d,this.prevBuffer)}},updateControlReg1:function(a){this.triggerRendering();this.f_nmiOnVblank=(a>>7)&1;this.f_spriteSize=(a>>5)&1;this.f_bgPatternTable=(a>>4)&1;this.f_spPatternTable=(a>>3)&1;this.f_addrInc=(a>>2)&1;this.f_nTblAddress=a&3;this.regV=(a>>1)&1;this.regH=a&1;this.regS=(a>>4)&1},updateControlReg2:function(a){this.triggerRendering();this.f_color=(a>>5)&7;this.f_spVisibility=(a>>4)&1;this.f_bgVisibility=(a>>3)&1;this.f_spClipping=(a>>2)&1;this.f_bgClipping=(a>>1)&1;this.f_dispType=a&1;if(this.f_dispType===0){this.palTable.setEmphasis(this.f_color)}this.updatePalettes()},setStatusFlag:function(a,b){var c=1<<a;this.nes.cpu.mem[0x2002]=((this.nes.cpu.mem[0x2002]&(255-c))|(b?c:0))},readStatusRegister:function(){var a=this.nes.cpu.mem[0x2002];this.firstWrite=true;this.setStatusFlag(this.STATUS_VBLANK,false);return a},writeSRAMAddress:function(a){this.sramAddress=a},sramLoad:function(){return this.spriteMem[this.sramAddress]},sramWrite:function(a){this.spriteMem[this.sramAddress]=a;this.spriteRamWriteUpdate(this.sramAddress,a);this.sramAddress++;this.sramAddress%=0x100},scrollWrite:function(a){this.triggerRendering();if(this.firstWrite){this.regHT=(a>>3)&31;this.regFH=a&7}else{this.regFV=a&7;this.regVT=(a>>3)&31}this.firstWrite=!this.firstWrite},writeVRAMAddress:function(a){if(this.firstWrite){this.regFV=(a>>4)&3;this.regV=(a>>3)&1;this.regH=(a>>2)&1;this.regVT=(this.regVT&7)|((a&3)<<3)}else{this.triggerRendering();this.regVT=(this.regVT&24)|((a>>5)&7);this.regHT=a&31;this.cntFV=this.regFV;this.cntV=this.regV;this.cntH=this.regH;this.cntVT=this.regVT;this.cntHT=this.regHT;this.checkSprite0(this.scanline-20)}this.firstWrite=!this.firstWrite;this.cntsToAddress();if(this.vramAddress<0x2000){this.nes.mmap.latchAccess(this.vramAddress)}},vramLoad:function(){var a;this.cntsToAddress();this.regsToAddress();if(this.vramAddress<=0x3EFF){a=this.vramBufferedReadValue;if(this.vramAddress<0x2000){this.vramBufferedReadValue=this.vramMem[this.vramAddress]}else{this.vramBufferedReadValue=this.mirroredLoad(this.vramAddress)}if(this.vramAddress<0x2000){this.nes.mmap.latchAccess(this.vramAddress)}this.vramAddress+=(this.f_addrInc==1?32:1);this.cntsFromAddress();this.regsFromAddress();return a}a=this.mirroredLoad(this.vramAddress);this.vramAddress+=(this.f_addrInc==1?32:1);this.cntsFromAddress();this.regsFromAddress();return a},vramWrite:function(a){this.triggerRendering();this.cntsToAddress();this.regsToAddress();if(this.vramAddress>=0x2000){this.mirroredWrite(this.vramAddress,a)}else{this.writeMem(this.vramAddress,a);this.nes.mmap.latchAccess(this.vramAddress)}this.vramAddress+=(this.f_addrInc==1?32:1);this.regsFromAddress();this.cntsFromAddress()},sramDMA:function(a){var b=a*0x100;var c;for(var d=this.sramAddress;d<256;d++){c=this.nes.cpu.mem[b+d];this.spriteMem[d]=c;this.spriteRamWriteUpdate(d,c)}this.nes.cpu.haltCycles(513)},regsFromAddress:function(){var a=(this.vramTmpAddress>>8)&0xFF;this.regFV=(a>>4)&7;this.regV=(a>>3)&1;this.regH=(a>>2)&1;this.regVT=(this.regVT&7)|((a&3)<<3);a=this.vramTmpAddress&0xFF;this.regVT=(this.regVT&24)|((a>>5)&7);this.regHT=a&31},cntsFromAddress:function(){var a=(this.vramAddress>>8)&0xFF;this.cntFV=(a>>4)&3;this.cntV=(a>>3)&1;this.cntH=(a>>2)&1;this.cntVT=(this.cntVT&7)|((a&3)<<3);a=this.vramAddress&0xFF;this.cntVT=(this.cntVT&24)|((a>>5)&7);this.cntHT=a&31},regsToAddress:function(){var a=(this.regFV&7)<<4;a|=(this.regV&1)<<3;a|=(this.regH&1)<<2;a|=(this.regVT>>3)&3;var b=(this.regVT&7)<<5;b|=this.regHT&31;this.vramTmpAddress=((a<<8)|b)&0x7FFF},cntsToAddress:function(){var a=(this.cntFV&7)<<4;a|=(this.cntV&1)<<3;a|=(this.cntH&1)<<2;a|=(this.cntVT>>3)&3;var b=(this.cntVT&7)<<5;b|=this.cntHT&31;this.vramAddress=((a<<8)|b)&0x7FFF},incTileCounter:function(a){for(var b=a;b!==0;b--){this.cntHT++;if(this.cntHT==32){this.cntHT=0;this.cntVT++;if(this.cntVT>=30){this.cntH++;if(this.cntH==2){this.cntH=0;this.cntV++;if(this.cntV==2){this.cntV=0;this.cntFV++;this.cntFV&=0x7}}}}}},mirroredLoad:function(a){return this.vramMem[this.vramMirrorTable[a]]},mirroredWrite:function(a,b){if(a>=0x3f00&&a<0x3f20){if(a==0x3F00||a==0x3F10){this.writeMem(0x3F00,b);this.writeMem(0x3F10,b)}else if(a==0x3F04||a==0x3F14){this.writeMem(0x3F04,b);this.writeMem(0x3F14,b)}else if(a==0x3F08||a==0x3F18){this.writeMem(0x3F08,b);this.writeMem(0x3F18,b)}else if(a==0x3F0C||a==0x3F1C){this.writeMem(0x3F0C,b);this.writeMem(0x3F1C,b)}else{this.writeMem(a,b)}}else{if(a<this.vramMirrorTable.length){this.writeMem(this.vramMirrorTable[a],b)}else{alert("Invalid VRAM address: "+a.toString(16))}}},triggerRendering:function(){if(this.scanline>=21&&this.scanline<=260){this.renderFramePartially(this.lastRenderedScanline+1,this.scanline-21-this.lastRenderedScanline);this.lastRenderedScanline=this.scanline-21}},renderFramePartially:function(a,b){if(this.f_spVisibility==1){this.renderSpritesPartially(a,b,true)}if(this.f_bgVisibility==1){var c=a<<8;var d=(a+b)<<8;if(d>0xF000){d=0xF000}var g=this.buffer;var h=this.bgbuffer;var f=this.pixrendered;for(var e=c;e<d;e++){if(f[e]>0xFF){g[e]=h[e]}}}if(this.f_spVisibility==1){this.renderSpritesPartially(a,b,false)}this.validTileData=false},renderBgScanline:function(a,b){var c=(this.regS===0?0:256);var d=(b<<8)-this.regFH;this.curNt=this.ntable1[this.cntV+this.cntV+this.cntH];this.cntHT=this.regHT;this.cntH=this.regH;this.curNt=this.ntable1[this.cntV+this.cntV+this.cntH];if(b<240&&(b-this.cntFV)>=0){var g=this.cntFV<<3;var h=this.scantile;var f=this.attrib;var e=this.ptTile;var j=this.nameTable;var i=this.imgPalette;var m=this.pixrendered;var k=a?this.bgbuffer:this.buffer;var l,q,p,s;for(var n=0;n<32;n++){if(b>=0){if(this.validTileData){l=h[n];q=l.pix;p=f[n]}else{l=e[c+j[this.curNt].getTileIndex(this.cntHT,this.cntVT)];q=l.pix;p=j[this.curNt].getAttrib(this.cntHT,this.cntVT);h[n]=l;f[n]=p}var o=0;var r=(n<<3)-this.regFH;if(r>-8){if(r<0){d-=r;o=-r}if(l.opaque[this.cntFV]){for(;o<8;o++){k[d]=i[q[g+o]+p];m[d]|=256;d++}}else{for(;o<8;o++){s=q[g+o];if(s!==0){k[d]=i[s+p];m[d]|=256}d++}}}}if(++this.cntHT==32){this.cntHT=0;this.cntH++;this.cntH%=2;this.curNt=this.ntable1[(this.cntV<<1)+this.cntH]}}this.validTileData=true}this.cntFV++;if(this.cntFV==8){this.cntFV=0;this.cntVT++;if(this.cntVT==30){this.cntVT=0;this.cntV++;this.cntV%=2;this.curNt=this.ntable1[(this.cntV<<1)+this.cntH]}else if(this.cntVT==32){this.cntVT=0}this.validTileData=false}},renderSpritesPartially:function(a,b,c){if(this.f_spVisibility===1){for(var d=0;d<64;d++){if(this.bgPriority[d]==c&&this.sprX[d]>=0&&this.sprX[d]<256&&this.sprY[d]+8>=a&&this.sprY[d]<a+b){if(this.f_spriteSize===0){this.srcy1=0;this.srcy2=8;if(this.sprY[d]<a){this.srcy1=a-this.sprY[d]-1}if(this.sprY[d]+8>a+b){this.srcy2=a+b-this.sprY[d]+1}if(this.f_spPatternTable===0){this.ptTile[this.sprTile[d]].render(this.buffer,0,this.srcy1,8,this.srcy2,this.sprX[d],this.sprY[d]+1,this.sprCol[d],this.sprPalette,this.horiFlip[d],this.vertFlip[d],d,this.pixrendered)}else{this.ptTile[this.sprTile[d]+256].render(this.buffer,0,this.srcy1,8,this.srcy2,this.sprX[d],this.sprY[d]+1,this.sprCol[d],this.sprPalette,this.horiFlip[d],this.vertFlip[d],d,this.pixrendered)}}else{var g=this.sprTile[d];if((g&1)!==0){g=this.sprTile[d]-1+256}var h=0;var f=8;if(this.sprY[d]<a){h=a-this.sprY[d]-1}if(this.sprY[d]+8>a+b){f=a+b-this.sprY[d]}this.ptTile[g+(this.vertFlip[d]?1:0)].render(this.buffer,0,h,8,f,this.sprX[d],this.sprY[d]+1,this.sprCol[d],this.sprPalette,this.horiFlip[d],this.vertFlip[d],d,this.pixrendered);h=0;f=8;if(this.sprY[d]+8<a){h=a-(this.sprY[d]+8+1)}if(this.sprY[d]+16>a+b){f=a+b-(this.sprY[d]+8)}this.ptTile[g+(this.vertFlip[d]?0:1)].render(this.buffer,0,h,8,f,this.sprX[d],this.sprY[d]+1+8,this.sprCol[d],this.sprPalette,this.horiFlip[d],this.vertFlip[d],d,this.pixrendered)}}}}},checkSprite0:function(a){this.spr0HitX=-1;this.spr0HitY=-1;var b;var c=(this.f_spPatternTable===0?0:256);var d,g,h,f;var e;var j;var i;d=this.sprX[0];g=this.sprY[0]+1;if(this.f_spriteSize===0){if(g<=a&&g+8>a&&d>=-7&&d<256){h=this.ptTile[this.sprTile[0]+c];j=this.sprCol[0];i=this.bgPriority[0];if(this.vertFlip[0]){b=7-(a-g)}else{b=a-g}b*=8;e=a*256+d;if(this.horiFlip[0]){for(f=7;f>=0;f--){if(d>=0&&d<256){if(e>=0&&e<61440&&this.pixrendered[e]!==0){if(h.pix[b+f]!==0){this.spr0HitX=e%256;this.spr0HitY=a;return true}}}d++;e++}}else{for(f=0;f<8;f++){if(d>=0&&d<256){if(e>=0&&e<61440&&this.pixrendered[e]!==0){if(h.pix[b+f]!==0){this.spr0HitX=e%256;this.spr0HitY=a;return true}}}d++;e++}}}}else{if(g<=a&&g+16>a&&d>=-7&&d<256){if(this.vertFlip[0]){b=15-(a-g)}else{b=a-g}if(b<8){h=this.ptTile[this.sprTile[0]+(this.vertFlip[0]?1:0)+((this.sprTile[0]&1)!==0?255:0)]}else{h=this.ptTile[this.sprTile[0]+(this.vertFlip[0]?0:1)+((this.sprTile[0]&1)!==0?255:0)];if(this.vertFlip[0]){b=15-b}else{b-=8}}b*=8;j=this.sprCol[0];i=this.bgPriority[0];e=a*256+d;if(this.horiFlip[0]){for(f=7;f>=0;f--){if(d>=0&&d<256){if(e>=0&&e<61440&&this.pixrendered[e]!==0){if(h.pix[b+f]!==0){this.spr0HitX=e%256;this.spr0HitY=a;return true}}}d++;e++}}else{for(f=0;f<8;f++){if(d>=0&&d<256){if(e>=0&&e<61440&&this.pixrendered[e]!==0){if(h.pix[b+f]!==0){this.spr0HitX=e%256;this.spr0HitY=a;return true}}}d++;e++}}}}return false},writeMem:function(a,b){this.vramMem[a]=b;if(a<0x2000){this.vramMem[a]=b;this.patternWrite(a,b)}else if(a>=0x2000&&a<0x23c0){this.nameTableWrite(this.ntable1[0],a-0x2000,b)}else if(a>=0x23c0&&a<0x2400){this.attribTableWrite(this.ntable1[0],a-0x23c0,b)}else if(a>=0x2400&&a<0x27c0){this.nameTableWrite(this.ntable1[1],a-0x2400,b)}else if(a>=0x27c0&&a<0x2800){this.attribTableWrite(this.ntable1[1],a-0x27c0,b)}else if(a>=0x2800&&a<0x2bc0){this.nameTableWrite(this.ntable1[2],a-0x2800,b)}else if(a>=0x2bc0&&a<0x2c00){this.attribTableWrite(this.ntable1[2],a-0x2bc0,b)}else if(a>=0x2c00&&a<0x2fc0){this.nameTableWrite(this.ntable1[3],a-0x2c00,b)}else if(a>=0x2fc0&&a<0x3000){this.attribTableWrite(this.ntable1[3],a-0x2fc0,b)}else if(a>=0x3f00&&a<0x3f20){this.updatePalettes()}},updatePalettes:function(){var a;for(a=0;a<16;a++){if(this.f_dispType===0){this.imgPalette[a]=this.palTable.getEntry(this.vramMem[0x3f00+a]&63)}else{this.imgPalette[a]=this.palTable.getEntry(this.vramMem[0x3f00+a]&32)}}for(a=0;a<16;a++){if(this.f_dispType===0){this.sprPalette[a]=this.palTable.getEntry(this.vramMem[0x3f10+a]&63)}else{this.sprPalette[a]=this.palTable.getEntry(this.vramMem[0x3f10+a]&32)}}},patternWrite:function(a,b){var c=Math.floor(a/16);var d=a%16;if(d<8){this.ptTile[c].setScanline(d,b,this.vramMem[a+8])}else{this.ptTile[c].setScanline(d-8,this.vramMem[a-8],b)}},nameTableWrite:function(a,b,c){this.nameTable[a].tile[b]=c;this.checkSprite0(this.scanline-20)},attribTableWrite:function(a,b,c){this.nameTable[a].writeAttrib(b,c)},spriteRamWriteUpdate:function(a,b){var c=Math.floor(a/4);if(c===0){this.checkSprite0(this.scanline-20)}if(a%4===0){this.sprY[c]=b}else if(a%4==1){this.sprTile[c]=b}else if(a%4==2){this.vertFlip[c]=((b&0x80)!==0);this.horiFlip[c]=((b&0x40)!==0);this.bgPriority[c]=((b&0x20)!==0);this.sprCol[c]=(b&3)<<2}else if(a%4==3){this.sprX[c]=b}},doNMI:function(){this.setStatusFlag(this.STATUS_VBLANK,true);this.nes.cpu.requestIrq(this.nes.cpu.IRQ_NMI)},JSON_PROPERTIES:['vramMem','spriteMem','cntFV','cntV','cntH','cntVT','cntHT','regFV','regV','regH','regVT','regHT','regFH','regS','vramAddress','vramTmpAddress','f_nmiOnVblank','f_spriteSize','f_bgPatternTable','f_spPatternTable','f_addrInc','f_nTblAddress','f_color','f_spVisibility','f_bgVisibility','f_spClipping','f_bgClipping','f_dispType','vramBufferedReadValue','firstWrite','currentMirroring','vramMirrorTable','ntable1','sramAddress','hitSpr0','sprPalette','imgPalette','curX','scanline','lastRenderedScanline','curNt','scantile','attrib','buffer','bgbuffer','pixrendered','requestEndFrame','nmiOk','dummyCycleToggle','nmiCounter','validTileData','scanlineAlreadyRendered'],toJSON:function(){var a;var b=JSNES.Utils.toJSON(this);b.nameTable=[];for(a=0;a<this.nameTable.length;a++){b.nameTable[a]=this.nameTable[a].toJSON()}b.ptTile=[];for(a=0;a<this.ptTile.length;a++){b.ptTile[a]=this.ptTile[a].toJSON()}return b},fromJSON:function(a){var b;JSNES.Utils.fromJSON(this,a);for(b=0;b<this.nameTable.length;b++){this.nameTable[b].fromJSON(a.nameTable[b])}for(b=0;b<this.ptTile.length;b++){this.ptTile[b].fromJSON(a.ptTile[b])}for(b=0;b<this.spriteMem.length;b++){this.spriteRamWriteUpdate(b,this.spriteMem[b])}}};JSNES.PPU.NameTable=function(a,b,c){this.width=a;this.height=b;this.name=c;this.tile=new Array(a*b);this.attrib=new Array(a*b)};JSNES.PPU.NameTable.prototype={getTileIndex:function(a,b){return this.tile[b*this.width+a]},getAttrib:function(a,b){return this.attrib[b*this.width+a]},writeAttrib:function(a,b){var c=(a%8)*4;var d=Math.floor(a/8)*4;var g;var h,f;var e;for(var j=0;j<2;j++){for(var i=0;i<2;i++){g=(b>>(2*(j*2+i)))&3;for(var m=0;m<2;m++){for(var k=0;k<2;k++){h=c+i*2+k;f=d+j*2+m;e=f*this.width+h;this.attrib[f*this.width+h]=(g<<2)&12}}}}},toJSON:function(){return{'tile':this.tile,'attrib':this.attrib}},fromJSON:function(a){this.tile=a.tile;this.attrib=a.attrib}};JSNES.PPU.PaletteTable=function(){this.curTable=new Array(64);this.emphTable=new Array(8);this.currentEmph=-1};JSNES.PPU.PaletteTable.prototype={reset:function(){this.setEmphasis(0)},loadNTSCPalette:function(){this.curTable=[0x525252,0xB40000,0xA00000,0xB1003D,0x740069,0x00005B,0x00005F,0x001840,0x002F10,0x084A08,0x006700,0x124200,0x6D2800,0x000000,0x000000,0x000000,0xC4D5E7,0xFF4000,0xDC0E22,0xFF476B,0xD7009F,0x680AD7,0x0019BC,0x0054B1,0x006A5B,0x008C03,0x00AB00,0x2C8800,0xA47200,0x000000,0x000000,0x000000,0xF8F8F8,0xFFAB3C,0xFF7981,0xFF5BC5,0xFF48F2,0xDF49FF,0x476DFF,0x00B4F7,0x00E0FF,0x00E375,0x03F42B,0x78B82E,0xE5E218,0x787878,0x000000,0x000000,0xFFFFFF,0xFFF2BE,0xF8B8B8,0xF8B8D8,0xFFB6FF,0xFFC3FF,0xC7D1FF,0x9ADAFF,0x88EDF8,0x83FFDD,0xB8F8B8,0xF5F8AC,0xFFFFB0,0xF8D8F8,0x000000,0x000000];this.makeTables();this.setEmphasis(0)},loadPALPalette:function(){this.curTable=[0x525252,0xB40000,0xA00000,0xB1003D,0x740069,0x00005B,0x00005F,0x001840,0x002F10,0x084A08,0x006700,0x124200,0x6D2800,0x000000,0x000000,0x000000,0xC4D5E7,0xFF4000,0xDC0E22,0xFF476B,0xD7009F,0x680AD7,0x0019BC,0x0054B1,0x006A5B,0x008C03,0x00AB00,0x2C8800,0xA47200,0x000000,0x000000,0x000000,0xF8F8F8,0xFFAB3C,0xFF7981,0xFF5BC5,0xFF48F2,0xDF49FF,0x476DFF,0x00B4F7,0x00E0FF,0x00E375,0x03F42B,0x78B82E,0xE5E218,0x787878,0x000000,0x000000,0xFFFFFF,0xFFF2BE,0xF8B8B8,0xF8B8D8,0xFFB6FF,0xFFC3FF,0xC7D1FF,0x9ADAFF,0x88EDF8,0x83FFDD,0xB8F8B8,0xF5F8AC,0xFFFFB0,0xF8D8F8,0x000000,0x000000];this.makeTables();this.setEmphasis(0)},makeTables:function(){var a,b,c,d,g,h,f,e;for(var j=0;j<8;j++){h=1.0;f=1.0;e=1.0;if((j&1)!==0){h=0.75;e=0.75}if((j&2)!==0){h=0.75;f=0.75}if((j&4)!==0){f=0.75;e=0.75}this.emphTable[j]=new Array(64);for(g=0;g<64;g++){d=this.curTable[g];a=Math.floor(this.getRed(d)*h);b=Math.floor(this.getGreen(d)*f);c=Math.floor(this.getBlue(d)*e);this.emphTable[j][g]=this.getRgb(a,b,c)}}},setEmphasis:function(a){if(a!=this.currentEmph){this.currentEmph=a;for(var b=0;b<64;b++){this.curTable[b]=this.emphTable[a][b]}}},getEntry:function(a){return this.curTable[a]},getRed:function(a){return(a>>16)&0xFF},getGreen:function(a){return(a>>8)&0xFF},getBlue:function(a){return a&0xFF},getRgb:function(a,b,c){return((a<<16)|(b<<8)|(c))},loadDefaultPalette:function(){this.curTable[0]=this.getRgb(117,117,117);this.curTable[1]=this.getRgb(39,27,143);this.curTable[2]=this.getRgb(0,0,171);this.curTable[3]=this.getRgb(71,0,159);this.curTable[4]=this.getRgb(143,0,119);this.curTable[5]=this.getRgb(171,0,19);this.curTable[6]=this.getRgb(167,0,0);this.curTable[7]=this.getRgb(127,11,0);this.curTable[8]=this.getRgb(67,47,0);this.curTable[9]=this.getRgb(0,71,0);this.curTable[10]=this.getRgb(0,81,0);this.curTable[11]=this.getRgb(0,63,23);this.curTable[12]=this.getRgb(27,63,95);this.curTable[13]=this.getRgb(0,0,0);this.curTable[14]=this.getRgb(0,0,0);this.curTable[15]=this.getRgb(0,0,0);this.curTable[16]=this.getRgb(188,188,188);this.curTable[17]=this.getRgb(0,115,239);this.curTable[18]=this.getRgb(35,59,239);this.curTable[19]=this.getRgb(131,0,243);this.curTable[20]=this.getRgb(191,0,191);this.curTable[21]=this.getRgb(231,0,91);this.curTable[22]=this.getRgb(219,43,0);this.curTable[23]=this.getRgb(203,79,15);this.curTable[24]=this.getRgb(139,115,0);this.curTable[25]=this.getRgb(0,151,0);this.curTable[26]=this.getRgb(0,171,0);this.curTable[27]=this.getRgb(0,147,59);this.curTable[28]=this.getRgb(0,131,139);this.curTable[29]=this.getRgb(0,0,0);this.curTable[30]=this.getRgb(0,0,0);this.curTable[31]=this.getRgb(0,0,0);this.curTable[32]=this.getRgb(255,255,255);this.curTable[33]=this.getRgb(63,191,255);this.curTable[34]=this.getRgb(95,151,255);this.curTable[35]=this.getRgb(167,139,253);this.curTable[36]=this.getRgb(247,123,255);this.curTable[37]=this.getRgb(255,119,183);this.curTable[38]=this.getRgb(255,119,99);this.curTable[39]=this.getRgb(255,155,59);this.curTable[40]=this.getRgb(243,191,63);this.curTable[41]=this.getRgb(131,211,19);this.curTable[42]=this.getRgb(79,223,75);this.curTable[43]=this.getRgb(88,248,152);this.curTable[44]=this.getRgb(0,235,219);this.curTable[45]=this.getRgb(0,0,0);this.curTable[46]=this.getRgb(0,0,0);this.curTable[47]=this.getRgb(0,0,0);this.curTable[48]=this.getRgb(255,255,255);this.curTable[49]=this.getRgb(171,231,255);this.curTable[50]=this.getRgb(199,215,255);this.curTable[51]=this.getRgb(215,203,255);this.curTable[52]=this.getRgb(255,199,255);this.curTable[53]=this.getRgb(255,199,219);this.curTable[54]=this.getRgb(255,191,179);this.curTable[55]=this.getRgb(255,219,171);this.curTable[56]=this.getRgb(255,231,163);this.curTable[57]=this.getRgb(227,255,163);this.curTable[58]=this.getRgb(171,243,191);this.curTable[59]=this.getRgb(179,255,207);this.curTable[60]=this.getRgb(159,255,243);this.curTable[61]=this.getRgb(0,0,0);this.curTable[62]=this.getRgb(0,0,0);this.curTable[63]=this.getRgb(0,0,0);this.makeTables();this.setEmphasis(0)}};JSNES.PPU.Tile=function(){this.pix=new Array(64);this.fbIndex=null;this.tIndex=null;this.x=null;this.y=null;this.w=null;this.h=null;this.incX=null;this.incY=null;this.palIndex=null;this.tpri=null;this.c=null;this.initialized=false;this.opaque=new Array(8)};JSNES.PPU.Tile.prototype={setBuffer:function(a){for(this.y=0;this.y<8;this.y++){this.setScanline(this.y,a[this.y],a[this.y+8])}},setScanline:function(a,b,c){this.initialized=true;this.tIndex=a<<3;for(this.x=0;this.x<8;this.x++){this.pix[this.tIndex+this.x]=((b>>(7-this.x))&1)+(((c>>(7-this.x))&1)<<1);if(this.pix[this.tIndex+this.x]===0){this.opaque[a]=false}}},render:function(a,b,c,d,g,h,f,e,j,i,m,k,l){if(h<-7||h>=256||f<-7||f>=240){return}this.w=d-b;this.h=g-c;if(h<0){b-=h}if(h+d>=256){d=256-h}if(f<0){c-=f}if(f+g>=240){g=240-f}if(!i&&!m){this.fbIndex=(f<<8)+h;this.tIndex=0;for(this.y=0;this.y<8;this.y++){for(this.x=0;this.x<8;this.x++){if(this.x>=b&&this.x<d&&this.y>=c&&this.y<g){this.palIndex=this.pix[this.tIndex];this.tpri=l[this.fbIndex];if(this.palIndex!==0&&k<=(this.tpri&0xFF)){a[this.fbIndex]=j[this.palIndex+e];this.tpri=(this.tpri&0xF00)|k;l[this.fbIndex]=this.tpri}}this.fbIndex++;this.tIndex++}this.fbIndex-=8;this.fbIndex+=256}}else if(i&&!m){this.fbIndex=(f<<8)+h;this.tIndex=7;for(this.y=0;this.y<8;this.y++){for(this.x=0;this.x<8;this.x++){if(this.x>=b&&this.x<d&&this.y>=c&&this.y<g){this.palIndex=this.pix[this.tIndex];this.tpri=l[this.fbIndex];if(this.palIndex!==0&&k<=(this.tpri&0xFF)){a[this.fbIndex]=j[this.palIndex+e];this.tpri=(this.tpri&0xF00)|k;l[this.fbIndex]=this.tpri}}this.fbIndex++;this.tIndex--}this.fbIndex-=8;this.fbIndex+=256;this.tIndex+=16}}else if(m&&!i){this.fbIndex=(f<<8)+h;this.tIndex=56;for(this.y=0;this.y<8;this.y++){for(this.x=0;this.x<8;this.x++){if(this.x>=b&&this.x<d&&this.y>=c&&this.y<g){this.palIndex=this.pix[this.tIndex];this.tpri=l[this.fbIndex];if(this.palIndex!==0&&k<=(this.tpri&0xFF)){a[this.fbIndex]=j[this.palIndex+e];this.tpri=(this.tpri&0xF00)|k;l[this.fbIndex]=this.tpri}}this.fbIndex++;this.tIndex++}this.fbIndex-=8;this.fbIndex+=256;this.tIndex-=16}}else{this.fbIndex=(f<<8)+h;this.tIndex=63;for(this.y=0;this.y<8;this.y++){for(this.x=0;this.x<8;this.x++){if(this.x>=b&&this.x<d&&this.y>=c&&this.y<g){this.palIndex=this.pix[this.tIndex];this.tpri=l[this.fbIndex];if(this.palIndex!==0&&k<=(this.tpri&0xFF)){a[this.fbIndex]=j[this.palIndex+e];this.tpri=(this.tpri&0xF00)|k;l[this.fbIndex]=this.tpri}}this.fbIndex++;this.tIndex--}this.fbIndex-=8;this.fbIndex+=256}}},isTransparent:function(a,b){return(this.pix[(b<<3)+a]===0)},toJSON:function(){return{'opaque':this.opaque,'pix':this.pix}},fromJSON:function(a){this.opaque=a.opaque;this.pix=a.pix}};JSNES.ROM=function(a){this.nes=a;this.mapperName=new Array(92);for(var b=0;b<92;b++){this.mapperName[b]="Unknown Mapper"}this.mapperName[0]="Direct Access";this.mapperName[1]="Nintendo MMC1";this.mapperName[2]="UNROM";this.mapperName[3]="CNROM";this.mapperName[4]="Nintendo MMC3";this.mapperName[5]="Nintendo MMC5";this.mapperName[6]="FFE F4xxx";this.mapperName[7]="AOROM";this.mapperName[8]="FFE F3xxx";this.mapperName[9]="Nintendo MMC2";this.mapperName[10]="Nintendo MMC4";this.mapperName[11]="Color Dreams Chip";this.mapperName[12]="FFE F6xxx";this.mapperName[15]="100-in-1 switch";this.mapperName[16]="Bandai chip";this.mapperName[17]="FFE F8xxx";this.mapperName[18]="Jaleco SS8806 chip";this.mapperName[19]="Namcot 106 chip";this.mapperName[20]="Famicom Disk System";this.mapperName[21]="Konami VRC4a";this.mapperName[22]="Konami VRC2a";this.mapperName[23]="Konami VRC2a";this.mapperName[24]="Konami VRC6";this.mapperName[25]="Konami VRC4b";this.mapperName[32]="Irem G-101 chip";this.mapperName[33]="Taito TC0190/TC0350";this.mapperName[34]="32kB ROM switch";this.mapperName[64]="Tengen RAMBO-1 chip";this.mapperName[65]="Irem H-3001 chip";this.mapperName[66]="GNROM switch";this.mapperName[67]="SunSoft3 chip";this.mapperName[68]="SunSoft4 chip";this.mapperName[69]="SunSoft5 FME-7 chip";this.mapperName[71]="Camerica chip";this.mapperName[78]="Irem 74HC161/32-based";this.mapperName[91]="Pirate HK-SF3 chip"};JSNES.ROM.prototype={VERTICAL_MIRRORING:0,HORIZONTAL_MIRRORING:1,FOURSCREEN_MIRRORING:2,SINGLESCREEN_MIRRORING:3,SINGLESCREEN_MIRRORING2:4,SINGLESCREEN_MIRRORING3:5,SINGLESCREEN_MIRRORING4:6,CHRROM_MIRRORING:7,header:null,rom:null,vrom:null,vromTile:null,romCount:null,vromCount:null,mirroring:null,batteryRam:null,trainer:null,fourScreen:null,mapperType:null,valid:false,load:function(a){var b,c,d;if(a.indexOf("NES\x1a")===-1){this.nes.ui.updateStatus("Not a valid NES ROM.");return}this.header=new Array(16);for(b=0;b<16;b++){this.header[b]=a.charCodeAt(b)&0xFF}this.romCount=this.header[4];this.vromCount=this.header[5]*2;this.mirroring=((this.header[6]&1)!==0?1:0);this.batteryRam=(this.header[6]&2)!==0;this.trainer=(this.header[6]&4)!==0;this.fourScreen=(this.header[6]&8)!==0;this.mapperType=(this.header[6]>>4)|(this.header[7]&0xF0);var g=false;for(b=8;b<16;b++){if(this.header[b]!==0){g=true;break}}if(g){this.mapperType&=0xF}this.rom=new Array(this.romCount);var h=16;for(b=0;b<this.romCount;b++){this.rom[b]=new Array(16384);for(c=0;c<16384;c++){if(h+c>=a.length){break}this.rom[b][c]=a.charCodeAt(h+c)&0xFF}h+=16384}this.vrom=new Array(this.vromCount);for(b=0;b<this.vromCount;b++){this.vrom[b]=new Array(4096);for(c=0;c<4096;c++){if(h+c>=a.length){break}this.vrom[b][c]=a.charCodeAt(h+c)&0xFF}h+=4096}this.vromTile=new Array(this.vromCount);for(b=0;b<this.vromCount;b++){this.vromTile[b]=new Array(256);for(c=0;c<256;c++){this.vromTile[b][c]=new JSNES.PPU.Tile()}}var f;var e;for(d=0;d<this.vromCount;d++){for(b=0;b<4096;b++){f=b>>4;e=b%16;if(e<8){this.vromTile[d][f].setScanline(e,this.vrom[d][b],this.vrom[d][b+8])}else{this.vromTile[d][f].setScanline(e-8,this.vrom[d][b-8],this.vrom[d][b])}}}this.valid=true},getMirroringType:function(){if(this.fourScreen){return this.FOURSCREEN_MIRRORING}if(this.mirroring===0){return this.HORIZONTAL_MIRRORING}return this.VERTICAL_MIRRORING},getMapperName:function(){if(this.mapperType>=0&&this.mapperType<this.mapperName.length){return this.mapperName[this.mapperType]}return"Unknown Mapper, "+this.mapperType},mapperSupported:function(){return typeof JSNES.Mappers[this.mapperType]!=='undefined'},createMapper:function(){if(this.mapperSupported()){return new JSNES.Mappers[this.mapperType](this.nes)}else{this.nes.ui.updateStatus("This ROM uses a mapper not supported by JSNES: "+this.getMapperName()+"("+this.mapperType+")");return null}}};JSNES.DummyUI=function(a){this.nes=a;this.enable=function(){};this.updateStatus=function(){};this.writeAudio=function(){};this.writeFrame=function(){}};if(typeof jQuery!=='undefined'){(function(i){i.fn.JSNESUI=function(f){var e=this;var j=function(b){var c=this;c.nes=b;c.root=i('<div></div>');c.screen=i('<canvas class="nes-screen" width="256" height="240"></canvas>').appendTo(c.root);if(!c.screen[0].getContext){e.html("Your browser doesn't support the <code>&lt;canvas&gt;</code> tag. Try Google Chrome, Safari, Opera or Firefox!");return}c.romContainer=i('<div class="nes-roms"></div>').appendTo(c.root);c.romSelect=i('<select></select>').appendTo(c.romContainer);c.controls=i('<div class="nes-controls"></div>').appendTo(c.root);c.buttons={pause:i('<input type="button" value="pause" class="nes-pause" disabled="disabled">').appendTo(c.controls),restart:i('<input type="button" value="restart" class="nes-restart" disabled="disabled">').appendTo(c.controls),sound:i('<input type="button" value="enable sound" class="nes-enablesound">').appendTo(c.controls),zoom:i('<input type="button" value="zoom in" class="nes-zoom">').appendTo(c.controls)};c.status=i('<p class="nes-status">Booting up...</p>').appendTo(c.root);c.root.appendTo(e);c.romSelect.change(function(){c.loadROM()});c.buttons.pause.click(function(){if(c.nes.isRunning){c.nes.stop();c.updateStatus("Paused");c.buttons.pause.attr("value","resume")}else{c.nes.start();c.buttons.pause.attr("value","pause")}});c.buttons.restart.click(function(){c.nes.reloadRom();c.nes.start()});c.buttons.sound.click(function(){if(c.nes.opts.emulateSound){c.nes.opts.emulateSound=false;c.buttons.sound.attr("value","enable sound")}else{c.nes.opts.emulateSound=true;c.buttons.sound.attr("value","disable sound")}});c.zoomed=false;c.buttons.zoom.click(function(){if(c.zoomed){c.screen.animate({width:'256px',height:'240px'});c.buttons.zoom.attr("value","zoom in");c.zoomed=false}else{c.screen.animate({width:'512px',height:'480px'});c.buttons.zoom.attr("value","zoom out");c.zoomed=true}});if(i.offset){c.screen.mousedown(function(a){if(c.nes.mmap){c.nes.mmap.mousePressed=true;c.nes.mmap.mouseX=a.pageX-c.screen.offset().left;c.nes.mmap.mouseY=a.pageY-c.screen.offset().top}}).mouseup(function(){setTimeout(function(){if(c.nes.mmap){c.nes.mmap.mousePressed=false;c.nes.mmap.mouseX=0;c.nes.mmap.mouseY=0}},500)})}if(typeof f!='undefined'){c.setRoms(f)}c.canvasContext=c.screen[0].getContext('2d');if(!c.canvasContext.getImageData){e.html("Your browser doesn't support writing pixels directly to the <code>&lt;canvas&gt;</code> tag. Try the latest versions of Google Chrome, Safari, Opera or Firefox!");return}c.canvasImageData=c.canvasContext.getImageData(0,0,256,240);c.resetCanvas();i(document).bind('keydown',function(a){c.nes.keyboard.keyDown(a)}).bind('keyup',function(a){c.nes.keyboard.keyUp(a)}).bind('keypress',function(a){c.nes.keyboard.keyPress(a)});c.dynamicaudio=new DynamicAudio({swf:b.opts.swfPath+'dynamicaudio.swf'})};j.prototype={loadROM:function(){var h=this;h.updateStatus("Downloading...");i.ajax({url:escape(h.romSelect.val()),xhr:function(){var a=i.ajaxSettings.xhr();if(typeof a.overrideMimeType!=='undefined'){a.overrideMimeType('text/plain; charset=x-user-defined')}h.xhr=a;return a},complete:function(a,b){var c,d;if(JSNES.Utils.isIE()){var g=JSNESBinaryToArray(a.responseBody).toArray();d=String.fromCharCode.apply(undefined,g)}else{d=a.responseText}h.nes.loadRom(d);h.nes.start();h.enable()}})},resetCanvas:function(){this.canvasContext.fillStyle='black';this.canvasContext.fillRect(0,0,256,240);for(var a=3;a<this.canvasImageData.data.length-3;a+=4){this.canvasImageData.data[a]=0xFF}},enable:function(){this.buttons.pause.attr("disabled",null);if(this.nes.isRunning){this.buttons.pause.attr("value","pause")}else{this.buttons.pause.attr("value","resume")}this.buttons.restart.attr("disabled",null);if(this.nes.opts.emulateSound){this.buttons.sound.attr("value","disable sound")}else{this.buttons.sound.attr("value","enable sound")}},updateStatus:function(a){this.status.text(a)},setRoms:function(a){this.romSelect.children().remove();i("<option>Select a ROM...</option>").appendTo(this.romSelect);for(var b in a){if(a.hasOwnProperty(b)){var c=i('<optgroup></optgroup>').attr("label",b);for(var d=0;d<a[b].length;d++){i('<option>'+a[b][d][0]+'</option>').attr("value",a[b][d][1]).appendTo(c)}this.romSelect.append(c)}}},writeAudio:function(a){return this.dynamicaudio.writeInt(a)},writeFrame:function(a,b){var c=this.canvasImageData.data;var d,g,h;for(g=0;g<256*240;g++){d=a[g];if(d!=b[g]){h=g*4;c[h]=d&0xFF;c[h+1]=(d>>8)&0xFF;c[h+2]=(d>>16)&0xFF;b[g]=d}}this.canvasContext.putImageData(this.canvasImageData,0,0)}};return j}})(jQuery)}